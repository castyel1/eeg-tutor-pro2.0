<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>EEG Tutor ‚Äì Pro v1.9 (Single-file)</title>
<style>
  :root{ --bg:#0f1115; --card:#151923; --muted:#9aa3b2; --text:#e8ecf1; --accent:#6ee7ff; --accent2:#a78bfa; --good:#22c55e; --bad:#ef4444; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:var(--text) }
  header{ padding:14px 16px; display:flex; align-items:center; justify-content:space-between; background:linear-gradient(180deg,#121726,#0f1115) }
  h1{ font-size:18px; margin:0; font-weight:700; letter-spacing:.3px }
  .badge{ font-size:11px; color:#cbd5e1; border:1px solid #334155; padding:2px 8px; border-radius:999px; margin-left:8px }
  .row{ display:flex; align-items:center; gap:10px }
  .container{ padding:12px; display:grid; gap:12px; max-width:1240px; margin:0 auto }
  .card{ background:var(--card); border:1px solid #1f2432; border-radius:16px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,.2) }
  .controls{ display:flex; gap:8px; flex-wrap:wrap }
  select, button, input[type='text']{ background:#0f1320; color:var(--text); border:1px solid #232a3b; border-radius:12px; padding:10px 12px; font-size:14px }
  button{ background:#0f1320; cursor:pointer }
  button.primary{ background:linear-gradient(180deg,#1b2a4a,#15223d); border-color:#2b395a }
  button.ghost{ background:transparent; border-color:#2b3346 }
  .muted{ color:var(--muted); font-size:13px }
  .grid{ display:grid; gap:10px }
  .two{ grid-template-columns:1fr 1fr }
  .hidden{ display:none }
  .pill{ padding:4px 8px; border:1px solid #2a3347; border-radius:999px; font-size:12px; color:#cbd5e1 }
  .score{ font-weight:700 }
  canvas{ width:100%; height:300px; background:#0b0f1a; border-radius:14px; border:1px solid #1e2434; touch-action:manipulation }
  .tabs{ display:flex; gap:8px }
  .tabs button{ flex:1 }
  .progress{ height:10px; background:#101525; border:1px solid #1e2434; border-radius:999px; overflow:hidden }
  .progress>div{ height:100%; background:linear-gradient(90deg,#22c55e,#84cc16); width:0% }
  .footer{ padding:10px; font-size:11px; color:#8b93a7; text-align:center }
  .kudos{ font-size:13px; padding:6px 10px; border-radius:10px }
  .ok{ background:#052e1b; border:1px solid #0b6b3f; color:#c7f9d4 }
  .no{ background:#3a0a0a; border:1px solid #7f1d1d; color:#fecaca }
  .small{ font-size:11px; color:#9aa3b2 }
  .lang{ cursor:pointer; user-select:none }
  .section-title{ font-weight:700; margin-bottom:6px }
  .chip{ font-size:11px; border:1px solid #2a3347; border-radius:999px; padding:2px 6px; color:#cbd5e1 }
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>EEG Tutor</h1>
    <span class="badge">Pro v1.9 ‚Ä¢ Single-file</span>
  </div>
  <div class="row">
    <span class="pill lang" id="langBtn">HU ‚ñæ</span>
    <span class="pill"><span id="lvl">1</span> <span id="lvlLbl">Szint</span></span>
    <span class="pill"><span id="xp">0</span> <span id="xpLbl">XP</span></span>
  </div>
</header>

<div class="container">
  <div class="card">
    <div class="tabs">
      <button id="tabExplore" class="primary">Explore</button>
      <button id="tabIdentify" class="ghost">Identify</button>
      <button id="tabQuiz" class="ghost">Quiz</button>
      <button id="tabLessons" class="ghost">Lessons</button>
    </div>
  </div>

  <!-- Explore -->
  <div class="card" id="explore">
    <div class="controls" style="margin-top:10px">
      <select id="caseSel"></select>
      <button id="toggleAns" class="ghost"><span id="solutionLbl">Megold√°s</span>: <span id="ansLbl">be</span></button>
      <button id="playBtn" class="ghost">‚èØÔ∏è Pause</button>
      <span class="pill"><span id="speedLbl">Sebess√©g</span> <span id="spdLbl">1.0√ó</span></span>
      <input type="range" id="speed" min="0.5" max="5" step="0.1" value="1" style="flex:1">
    </div>
    <div class="small" id="meta"></div>
    <div style="margin-top:8px" class="muted" id="desc"></div>
    <div class="small" id="tags" style="margin:6px 0 8px 0"></div>
    <canvas id="eeg"></canvas>
    <div class="grid two" style="margin-top:10px">
      <div class="card">
        <div class="section-title" id="explainHdr">R√©szletes magyar√°zat</div>
        <div id="explain" class="muted"></div>
      </div>
      <div class="card">
        <div class="section-title" id="tipsHdr">Tippek</div>
        <ul id="tips" class="muted" style="padding-left:18px"></ul>
      </div>
    </div>
  </div>

  <!-- Identify -->
  <div class="card hidden" id="identify">
    <div class="controls" style="margin-top:10px">
      <select id="difficulty"></select>
      <button id="newIdentify" class="primary">√öj feladat ‚Üí</button>
      <button id="freezeIdentify" class="ghost">üßä Freeze</button>
      <button id="hintBtn" class="ghost">üí° Tipp</button>
    </div>
    <div class="small" id="idfMeta" style="margin-top:6px"></div>
    <canvas id="eeg2"></canvas>
    <div class="controls" style="margin-top:8px">
      <input id="guess" type="text" placeholder="">
      <button id="check">Ellen≈ërz√©s</button>
    </div>
    <div id="fb" class="kudos hidden" style="margin-top:8px"></div>
  </div>

  <!-- Quiz -->
  <div class="card hidden" id="quiz">
    <div class="controls" style="margin-top:10px">
      <select id="caseSelQ"></select>
      <button id="resetQuiz" class="ghost">üîÑ Reset</button>
      <button id="freezeQuiz" class="ghost">üßä Freeze</button>
      <button id="snapshotQuiz" class="ghost">üì∏ Next snapshot</button>
      <button id="showSolution" class="primary">Megold√°s + XP</button>
    </div>
    <div class="small" id="task" style="margin-top:4px"></div>
    <canvas id="eeg3"></canvas>
    <div class="card" style="margin-top:10px">
      <div class="section-title" id="scoreHdr">Pontsz√°m</div>
      <div class="row" style="justify-content:space-between">
        <div id="hitLbl">Tal√°latok: <span id="hits" class="score">0</span> / <span id="total">0</span></div>
        <div><span id="totalLbl">√ñsszesen</span>: <span id="pct" class="score">0%</span></div>
      </div>
      <div class="progress" style="margin-top:8px"><div id="bar"></div></div>
      <div class="small" style="margin-top:6px"><span id="bestLbl">Legjobb</span>: <span id="best">0</span>%</div>
      <div class="small" id="noEvents" style="margin-top:6px; display:none"></div>
    </div>
  </div>

  <!-- Lessons -->
  <div class="card hidden" id="lessons">
    <div class="controls" style="margin-top:10px">
      <select id="lessonLevel"></select>
      <select id="lessonSel"></select>
      <button id="startLesson" class="primary">Start</button>
    </div>
    <div id="lessonBody" class="grid two"></div>
    <div id="lessonQuiz" class="card hidden" style="margin-top:10px">
      <div class="section-title" id="miniQuizHdr">Mini-quiz</div>
      <div class="small" id="lqInstr" style="margin-bottom:6px"></div>
      <div id="lqQ" class="muted" style="margin-bottom:8px"></div>
      <div class="controls" id="lqChoices" style="flex-direction:column;align-items:flex-start"></div>
      <div class="controls"><button id="lqSubmit" class="primary">Submit</button></div>
      <div id="lqFb" class="kudos hidden" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="card">
    <div class="section-title" id="medalHdr">Med√°lok</div>
    <ul id="medals" class="muted" style="padding-left:18px; margin:0"></ul>
  </div>

  <div class="footer" id="footerTxt">Canvas Dev build. K√∂v.: EDF/CSV import, JSON export, t√∂bb hard case, csatorna√©rz√©keny pontoz√°s.</div>
</div>

<script>
/* ================= i18n ================= */
const I18N = {
  HU: {
    explore:"Explore", identify:"Identify", quiz:"Quiz", lessons:"Lessons",
    solution:"Megold√°s", on:"be", off:"ki", pause:"Pause", play:"Play",
    speed:"Sebess√©g", details:"R√©szletes magyar√°zat", tips:"Tippek",
    beginner:"Kezd≈ë", intermediate:"K√∂z√©phalad√≥", hard:"Neh√©z", expert:"Expert", mixed:"Vegyes", all:"Mind",
    newTask:"√öj feladat ‚Üí", freeze:"üßä Fagyaszt√°s", hint:"üí° Tipp",
    guessPH:"Mi ez a minta? pl. LPDs, generalized spike-wave, triphasic, SIRPIDs‚Ä¶",
    check:"Ellen≈ërz√©s", score:"Pontsz√°m", hits:"Tal√°latok", total:"√ñsszesen",
    best:"Legjobb", medals:"Med√°lok", level:"Szint", xp:"XP",
    nextSnap:"üì∏ K√∂vetkez≈ë snapshot", reset:"üîÑ Reset", start:"Start",
    footer:"Canvas Dev build. K√∂v.: EDF/CSV import, JSON export, t√∂bb hard case, csatorna√©rz√©keny pontoz√°s.",
    correct:"+20 XP ‚Äì Helyes!", wrong:"+2 XP ‚Äì Nem ez. Megold√°s: ",
    hintText:"Els≈ë bet≈±k: ",
    caseMeta:(m,d,l)=>`Mont√°zs: ${m}  ‚Ä¢  Neh√©zs√©g: ${d}  ‚Ä¢  Minta: ${l}`,
    idfMeta:(d,m)=>`Neh√©zs√©g: ${d}  ‚Ä¢  Mont√°zs: ${m}`,
    task:(what)=>`Feladat: jel√∂ld be a(z) ${what} el≈ëfordul√°sait! (Freeze + Snapshot aj√°nlott)`,
    noEvents:"Ehhez a kiv√°lasztott esett√≠pushoz nincs c√≠mk√©zett esem√©ny a kv√≠zben. V√°lassz m√°sikat vagy k√©sz√≠ts snapshotot.",
    levelLbl:"Szint", xpLbl:"XP",
    miniQuiz:"Mini-quiz", selectAll:"Jel√∂ld meg az √∂sszes helyes √°ll√≠t√°st.", submit:"Bek√ºld√©s",
    gained:"Szerzett XP: ", bestPossible:"Max: ",
    lessonsBeginner:"Kezd≈ë", lessonsIntermediate:"K√∂z√©phalad√≥", lessonsExpert:"Expert",
    tags:{ benign:"j√≥indulat√∫", awake:"√©ber", sleep:"alv√°s", temporal:"tempor√°lis", frontal:"front√°lis", focal:"fok√°lis",
           generalized:"generaliz√°lt", rhythmic:"ritmikus", periodic:"periodikus", encephalopathy:"enkefalop√°tia",
           pediatric:"gyermek", artifact:"artefaktum", coma:"k√≥ma", anesthesia:"aneszt√©zia", fast:"gyors", variant:"vari√°ns" }
  },
  EN: {
    explore:"Explore", identify:"Identify", quiz:"Quiz", lessons:"Lessons",
    solution:"Solution", on:"on", off:"off", pause:"Pause", play:"Play",
    speed:"Speed", details:"Detailed explanation", tips:"Tips",
    beginner:"Beginner", intermediate:"Intermediate", hard:"Hard", expert:"Expert", mixed:"Mixed", all:"All",
    newTask:"New task ‚Üí", freeze:"üßä Freeze", hint:"üí° Hint",
    guessPH:"What is this pattern? e.g., LPDs, generalized spike‚Äìwave, triphasic, SIRPIDs‚Ä¶",
    check:"Check", score:"Score", hits:"Hits", total:"Total",
    best:"Best", medals:"Medals", level:"Level", xp:"XP",
    nextSnap:"üì∏ Next snapshot", reset:"üîÑ Reset", start:"Start",
    footer:"Canvas Dev build. Next: EDF/CSV import, JSON export, more hard cases, channel-aware scoring.",
    correct:"+20 XP ‚Äì Correct!", wrong:"+2 XP ‚Äì Not this. Solution: ",
    hintText:"Initials: ",
    caseMeta:(m,d,l)=>`Montage: ${m}  ‚Ä¢  Difficulty: ${d}  ‚Ä¢  Pattern: ${l}`,
    idfMeta:(d,m)=>`Difficulty: ${d}  ‚Ä¢  Montage: ${m}`,
    task:(what)=>`Task: click all ${what} occurrences! (Freeze + Snapshot recommended)`,
    noEvents:"This case has no labeled events for the quiz. Pick another or take a snapshot.",
    levelLbl:"Level", xpLbl:"XP",
    miniQuiz:"Mini-quiz", selectAll:"Select all correct statements.", submit:"Submit",
    gained:"XP gained: ", bestPossible:"Max: ",
    lessonsBeginner:"Beginner", lessonsIntermediate:"Intermediate", lessonsExpert:"Expert",
    tags:{ benign:"benign", awake:"awake", sleep:"sleep", temporal:"temporal", frontal:"frontal", focal:"focal",
           generalized:"generalized", rhythmic:"rhythmic", periodic:"periodic", encephalopathy:"encephalopathy",
           pediatric:"pediatric", artifact:"artifact", coma:"coma", anesthesia:"anesthesia", fast:"fast", variant:"variant" }
  }
};
let LANG = localStorage.getItem("eeg_lang") || "HU";
function tK(k){ return I18N[LANG][k] || k; }
function setLang(L){ LANG=L; localStorage.setItem("eeg_lang",L);
  syncTexts(); refreshCaseOptions(); refreshCaseOptionsQ(); buildDifficulty(); refreshLessons();
}
function diffName(d){
  const map={ beginner:'beginner', intermediate:'intermediate', hard:'hard', expert:'expert', mixed:'mixed', all:'all' };
  return tK(map[d]||d);
}
function trTag(tag){ return (I18N[LANG].tags||{})[tag]||tag; }

/* ============== Egyszer≈± XP (profil n√©lk√ºl) ============== */
let XP = parseInt(localStorage.getItem('eeg_xp')||'0',10);
let BEST = parseInt(localStorage.getItem('eeg_best')||'0',10);
let STREAK = parseInt(localStorage.getItem('eeg_streak')||'0',10);
function levelFromXP(x){ return Math.floor(x/100)+1; }
function saveProgress(){ localStorage.setItem('eeg_xp', XP); localStorage.setItem('eeg_best', BEST); localStorage.setItem('eeg_streak', STREAK); }
function awardXP(n){ XP+=n; saveProgress(); refreshMeta(); }
function medalsList(){ const m=[]; if(STREAK>=5)m.push('Komb√°jn ‚Äì 5 helyes egym√°s ut√°n'); if(BEST>=90)m.push('Sasszem ‚Äì 90%+'); if(XP>=300)m.push('Maraton ‚Äì 300 XP'); return m; }
function refreshMeta(){
  byId('xp').textContent=String(XP);
  byId('lvl').textContent=String(levelFromXP(XP));
  byId('lvlLbl').textContent=tK('levelLbl');
  byId('xpLbl').textContent=tK('xpLbl');
  byId('best').textContent=String(BEST);
  const ul=byId('medals'); ul.innerHTML='';
  const m=medalsList();
  if(!m.length){ ul.innerHTML='<li>'+(LANG==='HU'?'M√©g nincs ‚Äì gy≈±jts kih√≠v√°sokat!':'No medals yet ‚Äî keep going!')+'</li>'; }
  else m.forEach(x=>{ const li=document.createElement('li'); li.textContent=x; ul.appendChild(li); });
}

/* ============== Adatgener√°l√°s, esetek ============== */
function genChannel(N, noise=0.6, spikes=[], mag=4, baseHz=0){
  const arr=[]; for(let i=0;i<N;i++){
    const base=(baseHz?Math.sin(i/(S/(baseHz*2*Math.PI)))*1.0:0) + Math.sin(i/25)*0.6;
    const drift=Math.sin(i/220)*0.4;
    let v=base+drift+(Math.random()-0.5)*noise;
    if(spikes.includes(i)) v+=mag;
    if(spikes.some(s=>Math.abs(i-s)<=2)){
      const near=spikes.find(s=>Math.abs(i-s)<=2);
      v+=mag*(1-Math.abs(i-near)/2);
    }
    arr.push(v);
  }
  return arr;
}
const S=1000; // ~10 s
function makeCase(id,meta){ return Object.assign({id, sampleRate:S}, meta); }
function materialize(c){
  c.channels=c.channels.map((name,idx)=>{
    const spikes=(typeof c.spikesFn==="function")?c.spikesFn(idx):[];
    return {name, data:genChannel(S, c.noise||0.45, spikes, c.magFn?c.magFn(idx):4, c.baseHz||0), spikes};
  }); return c;
}

/* ============== Esetsor (25+ minta, r√©szletesebb le√≠r√°sok) ============== */
const CASES = [
  // Benign / normal / artifacts
  makeCase('normal_alpha',{ titleHU:'Norm√°l √©ber ‚Äì occipitalis alfa', titleEN:'Normal awake ‚Äì occipital alpha',
    montage:'10‚Äì20', descHU:'8‚Äì10 Hz occipitalis alfa, szemnyit√°sra g√°tl√≥dik.', descEN:'8‚Äì10 Hz occipital alpha; blocked by eye opening.',
    explainHU:'A norm√°l √©ber h√°tt√©r ritmusos, szimmetrikus √©s reakt√≠v. Az occipitalis maximum √©s a szemnyit√°sra t√∂rt√©n≈ë elt≈±n√©s kulcsfontoss√°g√∫ k√ºl√∂nbs√©g a patol√≥gi√°t√≥l.',
    explainEN:'Normal awake background is rhythmic, symmetric and reactive. Occipital maximum and eye-opening reactivity distinguish it from pathology.',
    tipsHU:['Szimmetrikus occipitalis maximum','Reakt√≠v szemnyit√°sra','Nincs hegyes cs√∫cs/spike','Fok√°lis aszimmetria hi√°nya'],
    tipsEN:['Symmetric occipital maximum','Reactive to eye opening','No sharp spike','No focal asymmetry'],
    diff:'beginner', label:'normal alpha',
    channels:['O1-O2','P3-O1','P4-O2','C3-P3','C4-P4'], spikesFn:()=>[], magFn:()=>0, baseHz:9,
    includeInQuiz:false, quizTargetHU:'alfa ritmus', quizTargetEN:'alpha rhythm', tags:['benign','awake'] }),
  makeCase('mu_rhythm',{ titleHU:'Mu-ritmus (centr√°lis)', titleEN:'Mu rhythm (central)',
    montage:'Cz ref', descHU:'8‚Äì13 Hz √≠vszer≈± aktivit√°s C3/C4 k√∂r√ºl, mozg√°s/blokkol√°s.', descEN:'8‚Äì13 Hz arch-shaped over C3/C4; blocked by movement.',
    explainHU:'Benignus ritmus a sensorimotoros k√©reg felett. Gyakori buktat√≥ az occipitalis alf√°val val√≥ √∂sszekever√©s ‚Äî a topogr√°fia seg√≠t.',
    explainEN:'Benign rhythm over sensorimotor cortex. Common pitfall is confusing with occipital alpha ‚Äî topography differentiates.',
    tipsHU:['Centr√°lis maximum (C3/C4)','√çvszer≈± hull√°mforma','Mozg√°sra g√°tl√≥dik','Nem occipitalis'],
    tipsEN:['Central maximum (C3/C4)','Arch-shaped','Blocked by movement','Not occipital'],
    diff:'beginner', label:'mu rhythm',
    channels:['C3-Cz','Cz-C4','C3-P3','C4-P4'], spikesFn:()=>[], magFn:()=>0, baseHz:10,
    includeInQuiz:false, quizTargetHU:'mu-ritmus', quizTargetEN:'mu rhythm', tags:['benign','awake','variant'] }),
  makeCase('sleep_spindles',{ titleHU:'N2 ‚Äì alv√°si ors√≥k', titleEN:'N2 ‚Äì sleep spindles',
    montage:'10‚Äì20', descHU:'12‚Äì14 Hz ors√≥k centr√°lisan; gyakran K-komplex k√≠s√©ri.', descEN:'12‚Äì14 Hz central spindles; often with K-complex.',
    explainHU:'Fiziol√≥gi√°s alv√°sjel. Az ors√≥k vonatszer≈±ek, centr√°lisan maxim√°lisak. Nem keverend≈ëk √∂ssze patol√≥gi√°s gyors aktivit√°ssal.',
    explainEN:'Physiologic sleep marker. Spindles occur in trains with central maximum; do not confuse with pathologic fast activity.',
    tipsHU:['Centr√°lis maximum','12‚Äì14 Hz s√°v','Vonatszer≈± megjelen√©s','N2 kontextus'],
    tipsEN:['Central maximum','12‚Äì14 Hz band','Trains','N2 context'],
    diff:'beginner', label:'sleep spindles',
    channels:['C3-P3','C4-P4','Fz-Cz'], spikesFn:()=>[], magFn:()=>0, baseHz:13,
    includeInQuiz:false, quizTargetHU:'ors√≥', quizTargetEN:'spindle', tags:['sleep','benign'] }),
  makeCase('k_complex',{ titleHU:'K-komplex', titleEN:'K-complex',
    montage:'Frontocentr√°lis', descHU:'Magas amplit√∫d√≥j√∫ bif√°zisos hull√°m N2-ben.', descEN:'High-amplitude biphasic wave in N2.',
    explainHU:'√Åtmeneti, izol√°lt √©les-lass√∫ hull√°m; fiziol√≥gi√°s. K√∂nny≈± √∂sszekeverni epileptiform lass√∫ hull√°mmal ‚Äî a kontextus d√∂nt.',
    explainEN:'Transient sharp-slow complex; physiologic. Context prevents mislabeling as epileptiform.',
    tipsHU:['Frontocentr√°lis cs√∫cs','Magas amplit√∫d√≥','N2 alv√°s','Gyakran ors√≥val egy√ºtt'],
    tipsEN:['Frontocentral','High amplitude','N2 sleep','Often near spindles'],
    diff:'beginner', label:'k-complex',
    channels:['F3-C3','F4-C4','Cz-Pz'], spikesFn:(i)=> (i===1?[400]:[]), magFn:(i)=> (i===1?6:2), noise:0.3,
    includeInQuiz:true, quizTargetHU:'K-komplex', quizTargetEN:'K-complex', tags:['sleep','benign'] }),
  makeCase('vertex_sharp',{ titleHU:'Vertex √©les tranziens', titleEN:'Vertex sharp transient',
    montage:'Cz', descHU:'Keskeny, √©les hull√°m a vertexben (N1/N2).', descEN:'Narrow sharp at vertex (N1/N2).',
    explainHU:'Fiziol√≥gi√°s; mag√°nyos vagy r√∂vid sorozatban. Nem k√∂veti k√∂telez≈ëen lass√∫ hull√°m.',
    explainEN:'Physiologic; isolated or brief runs. Not obligatorily followed by slow wave.',
    tipsHU:['Cz k√∂r√ºl legnagyobb','Keskeny, r√∂vid','N1/N2 f√°zis'], tipsEN:['Near Cz maximum','Narrow, brief','N1/N2 stage'],
    diff:'beginner', label:'vertex sharp',
    channels:['Fz-Cz','Cz-Pz'], spikesFn:(i)=> (i===0?[300,700]:[]), magFn:(i)=> (i===0?5:2),
    includeInQuiz:true, quizTargetHU:'vertex √©les', quizTargetEN:'vertex sharp', tags:['sleep','benign'] }),
  makeCase('eyeblink',{ titleHU:'Artefaktum ‚Äì pislog√°s', titleEN:'Artifact ‚Äì eye blink',
    montage:'Front√°lis', descHU:'Nagy front√°lis lass√∫ deflexi√≥.', descEN:'Large frontal slow deflection.',
    explainHU:'Sima le- √©s felfut√°s, front√°lis t√∫ls√∫ly; gyakran p√°ros√°val. Nem hegyes, nincs ut√≥lagos lass√∫ hull√°m mint epileptiformn√°l.',
    explainEN:'Smooth slow deflection, frontal predominance; often paired. Not sharp, no stereotyped slow wave afterwards.',
    tipsHU:['Front√°lis dominancia','Sima cs√∫cs','Polarit√°s √©s id≈ëz√≠t√©s seg√≠t','√ñsszevet√©s EOG-gal'],
    tipsEN:['Frontal dominance','Smooth peak','Polarity/timing help','Check EOG if available'],
    diff:'beginner', label:'eye blink',
    channels:['Fp1-F3','Fp2-F4','Fz-Cz'], spikesFn:(i)=> (i===0?[150,520]:[]), magFn:(i)=> (i===0?6:2), noise:0.3,
    includeInQuiz:false, quizTargetHU:'pislog√°s', quizTargetEN:'blink', tags:['artifact'] }),
  makeCase('emg',{ titleHU:'Artefaktum ‚Äì EMG', titleEN:'Artifact ‚Äì EMG',
    montage:'Front√°lis/tempor√°lis', descHU:'Sz√©less√°v√∫, magasfrekvenci√°s zaj.', descEN:'Broadband high-frequency noise.',
    explainHU:'Izomt√≥nus okozza; inkoherens t√∂bb csatorna k√∂zt. Nem spike-slow p√°ros.',
    explainEN:'Muscle tone; incoherent across channels. No spike‚Äìslow pairing.',
    tipsHU:['Sz√©less√°v√∫ spektrum','Inkoherens topogr√°fia','Jobb √°llcs√∫cson/hal√°nt√©kon'], tipsEN:['Broadband','Incoherent topography','Often chin/temporal'],
    diff:'intermediate', label:'emg',
    channels:['F7-T3','T3-T5','F8-T4','T4-T6'], spikesFn:()=>[], magFn:()=>0, baseHz:0, noise:0.9,
    includeInQuiz:false, quizTargetHU:'EMG', quizTargetEN:'EMG', tags:['artifact'] }),
  makeCase('ecg_artifact',{ titleHU:'Artefaktum ‚Äì EKG', titleEN:'Artifact ‚Äì ECG',
    montage:'Diff√∫z', descHU:'Ritmikus cs√∫csok EKG-√ºtemre.', descEN:'Rhythmic peaks time-locked to ECG.',
    explainHU:'Csatornaf√ºggetlen id≈ëz√≠t√©s; occipitalisan is l√°that√≥ lehet. Nem epileptiform.',
    explainEN:'Time-locked across channels; may appear occipitally. Non-epileptiform.',
    tipsHU:['Ritmikus, sz√≠vfrekvenci√°val','Csatornaf√ºggetlen','Egyidej≈± EKG seg√≠t'], tipsEN:['Rhythmic with HR','Channel-independent','Check ECG'],
    diff:'intermediate', label:'ecg artifact',
    channels:['C3-P3','C4-P4','P3-O1','P4-O2'], spikesFn:(i)=>[150,350,550,750,950], magFn:()=>3,
    includeInQuiz:true, quizTargetHU:'EKG-cs√∫csok', quizTargetEN:'ECG peaks', tags:['artifact'] }),

  // Epileptiform / periodic / rhythmic
  makeCase('gsw3',{ titleHU:'Generaliz√°lt t√ºske-hull√°m (~3 Hz)', titleEN:'Generalized spike‚Äìwave (~3 Hz)',
    montage:'10‚Äì20 ref', descHU:'Szinkron 3 Hz spike + lass√∫ hull√°m.', descEN:'Synchronous 3 Hz spike + slow wave.',
    explainHU:'Tipikus generaliz√°lt epilepszi√°kban. Meredek spike ut√°n szab√°lyos lass√∫ hull√°m; sz√©lesk√∂r≈± √©s √∂sszehangolt.',
    explainEN:'Classic in generalized epilepsies. Steep spike followed by slow wave; diffuse and highly synchronous.',
    tipsHU:['Szinkron megjelen√©s','2.5‚Äì3.5 Hz','Spike + slow wave p√°rok','Nem keverend≈ë EMG-vel'],
    tipsEN:['Synchronous','2.5‚Äì3.5 Hz','Spike‚Äìslow pairs','Do not confuse with EMG'],
    diff:'beginner', label:'generalized spike-wave',
    channels:['Fp1-F3','F3-C3','C3-P3','P3-O1','Fp2-F4','F4-C4','C4-P4','P4-O2'],
    spikesFn:()=>[160,190,220,250,280,310,340], magFn:(i)=>5-(i%3),
    includeInQuiz:true, quizTargetHU:'t√ºske-hull√°m', quizTargetEN:'spike‚Äìwave', tags:['generalized','ictal/interictal','rhythmic'] }),
  makeCase('polyspike_wave',{ titleHU:'Generaliz√°lt polyt√ºske‚Äìhull√°m', titleEN:'Generalized polyspike‚Äìwave',
    montage:'10‚Äì20', descHU:'Gyorsan k√∂vet≈ë spikesorozat lass√∫ hull√°mmal.', descEN:'Rapid spikes followed by slow wave.',
    explainHU:'JME-ben gyakori; t√∂bb cs√∫cs egy lass√∫ hull√°m el≈ëtt.', explainEN:'Typical in JME; multiple spikes before slow wave.',
    tipsHU:['T√∂bbsz√∂r√∂s spike','Generaliz√°lt','Myoclonushoz t√°rsulhat'], tipsEN:['Multiple spikes','Generalized','May accompany myoclonus'],
    diff:'intermediate', label:'polyspike-wave',
    channels:['Fp1-F3','F3-C3','C3-P3','Fp2-F4','F4-C4','C4-P4'], spikesFn:()=>[300,305,310,600,605,610], magFn:(i)=>5-(i%2),
    includeInQuiz:true, quizTargetHU:'polyt√ºsk√©k', quizTargetEN:'polyspikes', tags:['generalized'] }),
  makeCase('lt_spikes',{ titleHU:'Bal tempor√°lis t√ºsk√©k', titleEN:'Left temporal spikes',
    montage:'Bitempor√°lis', descHU:'Fok√°lis t√ºsk√©k T3/T5 maximummal.', descEN:'Focal spikes with T3/T5 maximum.',
    explainHU:'Aszinkron t√∂bb csatorn√°n, keskeny meredek cs√∫cs; lass√∫ hull√°m k√≠s√©rheti.', explainEN:'Asynchronous across channels; steep narrow peak; often with slow wave.',
    tipsHU:['Ipsilater√°lis maximum','Meredek, keskeny','Id≈ëbeli aszinkron'], tipsEN:['Ipsilateral max','Steep narrow','Temporal asynchrony'],
    diff:'intermediate', label:'left temporal spikes',
    channels:['F7-T3','T3-T5','T5-O1','F8-T4','T4-T6','T6-O2'],
    spikesFn:(i)=> (i<3?[200,410,640]:[205,415,645]), magFn:(i)=> (i<3?5:2),
    includeInQuiz:true, quizTargetHU:'fok√°lis t√ºsk√©k', quizTargetEN:'focal spikes', tags:['temporal','focal'] }),
  makeCase('rt_spikes',{ titleHU:'Jobb tempor√°lis t√ºsk√©k', titleEN:'Right temporal spikes',
    montage:'Bitempor√°lis', descHU:'Fok√°lis t√ºsk√©k T4/T6 maximum.', descEN:'Focal spikes T4/T6 maximum.',
    explainHU:'Id≈ëben sz√≥rt, csatorn√°nk√©nt elt√©r≈ë amplit√∫d√≥.', explainEN:'Temporally scattered; amplitude differs by channel.',
    tipsHU:['Ipsilater√°lis maximum','Keskeny cs√∫cs','Lass√∫ hull√°m k√≠s√©rheti'], tipsEN:['Ipsilateral max','Narrow peak','Often slow wave'],
    diff:'intermediate', label:'right temporal spikes',
    channels:['F7-T3','T3-T5','T5-O1','F8-T4','T4-T6','T6-O2'],
    spikesFn:(i)=> (i>=3?[220,430,660]:[225,435,665]), magFn:(i)=> (i>=3?5:2),
    includeInQuiz:true, quizTargetHU:'fok√°lis t√ºsk√©k', quizTargetEN:'focal spikes', tags:['temporal','focal'] }),
  makeCase('frontal_spikes',{ titleHU:'Front√°lis keskeny t√ºsk√©k', titleEN:'Frontal narrow spikes',
    montage:'Referenci√°lis', descHU:'Finom, kev√©s csatorn√°n l√°tsz√≥ t√ºsk√©k.', descEN:'Subtle spikes on few channels.',
    explainHU:'EMG-t≈ël elk√ºl√∂n√≠t√©s: cs√∫cs meredeks√©ge √©s id≈ëbeli koherencia.', explainEN:'Differentiate from EMG via steepness and temporal coherence.',
    tipsHU:['Front√°lis t√∫ls√∫ly','Keskeny cs√∫cs','Koherens id≈ëz√≠t√©s'], tipsEN:['Frontal predominance','Narrow peak','Coherent timing'],
    diff:'hard', label:'right frontal spikes',
    channels:['F4-Fz','Fz-Cz','F8-F4','F4-C4'],
    spikesFn:(i)=> (i%2===0?[260,520]:[]), magFn:(i)=> (i%2===0?5:1),
    includeInQuiz:true, quizTargetHU:'front√°lis t√ºsk√©k', quizTargetEN:'frontal spikes', tags:['frontal','focal'] }),
  makeCase('lpds',{ titleHU:'LPDs ‚Äì later√°lis periodikus kis√ºl√©sek (jobb)', titleEN:'LPDs ‚Äì lateralized periodic discharges (right)',
    montage:'Referenci√°lis', descHU:'Periodikus jobb oldali kis√ºl√©sek.', descEN:'Periodic right-sided discharges.',
    explainHU:'Ictal-interictal kontinuum r√©sze; klinikum √©s evol√∫ci√≥ d√∂nt.', explainEN:'Part of IIC; clinical correlation and evolution matter.',
    tipsHU:['1‚Äì2 s peri√≥dus','Later√°lis dominancia','F√≥kuszhoz k√∂t≈ëdik'], tipsEN:['1‚Äì2 s period','Lateralized','Linked to lesion'],
    diff:'hard', label:'lpds',
    channels:['F8-T4','T4-T6','T6-O2','F7-T3','T3-T5'],
    spikesFn:(i)=> (i<3?[150,300,450,600,750]:[]), magFn:(i)=> (i<3?4:1),
    includeInQuiz:true, quizTargetHU:'periodikus kis√ºl√©sek', quizTargetEN:'periodic discharges', tags:['periodic','focal'] }),
  makeCase('lrda',{ titleHU:'LRDA ‚Äì later√°lis ritmikus delta', titleEN:'LRDA ‚Äì lateralized rhythmic delta',
    montage:'Tempor√°lis', descHU:'Ritmikus delta later√°lisan.', descEN:'Rhythmic delta with lateralization.',
    explainHU:'IIC spektrum; fok√°lis rizik√≥jel.', explainEN:'IIC spectrum; focal risk marker.',
    tipsHU:['Ritmikus megjelen√©s','Later√°lis t√∫ls√∫ly','Klinikai korrel√°tum'], tipsEN:['Rhythmic','Lateralized','Clinical context'],
    diff:'intermediate', label:'lrda',
    channels:['T3-T5','T5-O1','T4-T6','T6-O2'],
    spikesFn:()=>[200,400,600,800], magFn:()=>2,
    includeInQuiz:true, quizTargetHU:'ritmikus delta', quizTargetEN:'rhythmic delta', tags:['rhythmic'] }),
  makeCase('grda',{ titleHU:'GRDA ‚Äì generaliz√°lt ritmikus delta', titleEN:'GRDA ‚Äì generalized rhythmic delta',
    montage:'Generaliz√°lt', descHU:'Diff√∫z ritmikus delta.', descEN:'Diffuse rhythmic delta.',
    explainHU:'Encephalopathia jele; nem tipikusan epileptiform.', explainEN:'Marker of encephalopathy; non-epileptiform.',
    tipsHU:['Diff√∫z eloszl√°s','Ritmusoss√°g','Klinikum sz√°m√≠t'], tipsEN:['Diffuse','Rhythmic','Clinical context'],
    diff:'intermediate', label:'grda',
    channels:['F3-C3','F4-C4','C3-P3','C4-P4'],
    spikesFn:()=>[250,350,450,550,650,750], magFn:()=>2,
    includeInQuiz:true, quizTargetHU:'ritmikus delta', quizTargetEN:'rhythmic delta', tags:['rhythmic','generalized','encephalopathy'] }),
  makeCase('gpeds',{ titleHU:'GPDs ‚Äì generaliz√°lt periodikus kis√ºl√©sek', titleEN:'GPDs ‚Äì generalized periodic discharges',
    montage:'Referenci√°lis', descHU:'Generaliz√°lt periodicit√°s.', descEN:'Generalized periodic pattern.',
    explainHU:'Metabolikus/toxikus/posztanoxi√°s okok gyakoriak; ictalis elemek fel√© billenhet evol√∫ci√≥val.', explainEN:'Often metabolic/toxic/post-anoxic; may tilt toward ictus if evolving.',
    tipsHU:['Diff√∫z megjelen√©s','Periodikus id≈ëk√©s√©s','Evol√∫ci√≥ keres√©se'], tipsEN:['Diffuse','Periodic delay','Look for evolution'],
    diff:'hard', label:'gpds',
    channels:['F3-C3','C3-P3','F4-C4','C4-P4','P3-O1','P4-O2'],
    spikesFn:(i)=>[200,400,600,800], magFn:(i)=>3,
    includeInQuiz:true, quizTargetHU:'periodikus kis√ºl√©sek', quizTargetEN:'periodic discharges', tags:['periodic','generalized','encephalopathy'] }),
  makeCase('triphasic',{ titleHU:'Triphasic hull√°mok', titleEN:'Triphasic waves',
    montage:'Referenci√°lis', descHU:'Metabolikus encephalopathia mint√°zat.', descEN:'Pattern of metabolic encephalopathy.',
    explainHU:'H√°rom egym√°st k√∂vet≈ë f√°zis, front√°lis t√∫ls√∫ly, nem epileptiform. Tempusban vonulhat; klinikum d√∂nt.', explainEN:'Three sequential phases, frontal predominance; non-epileptiform. May march in time; clinical context matters.',
    tipsHU:['Front√°lis t√∫ls√∫ly','H√°rom f√°zis','Nem ‚Äûspike + slow‚Äù','Ritk√°n evolv√°l ictusba'], tipsEN:['Frontal pred.','Three phases','Not spike+slow','Rare ictal evolution'],
    diff:'hard', label:'triphasic waves',
    channels:['Fp1-F3','F3-C3','Fz-Cz','Fp2-F4','F4-C4'],
    spikesFn:()=>[140,300,470,640], magFn:()=>2,
    includeInQuiz:true, quizTargetHU:'triphasicus komplexek', quizTargetEN:'triphasic complexes', tags:['encephalopathy','rhythmic'] }),
  makeCase('sirpids',{ titleHU:'SIRPIDs-szer≈± aktivit√°s', titleEN:'SIRPIDs-like activity',
    montage:'Referenci√°lis', descHU:'Stimulus ut√°n ritmikus/periodikus aktivit√°s.', descEN:'Rhythmic/periodic activity after stimulus.',
    explainHU:'Kritikusan betegekn√©l; nem egyenl≈ë ictussal, de IIC r√©sze.', explainEN:'Seen in critical illness; not identical to ictus but within IIC.',
    tipsHU:['Stimulus-kapcsolat','Ritmikus szakaszok','Klinikai korrel√°ci√≥'], tipsEN:['Stimulus-linked','Rhythmic runs','Clinical correlation'],
    diff:'intermediate', label:'sirpids',
    channels:['F3-C3','C3-P3','F4-C4','C4-P4'],
    spikesFn:(i)=>[220,400,580], magFn:()=>3,
    includeInQuiz:true, quizTargetHU:'induk√°lt ritmus', quizTargetEN:'induced rhythm', tags:['critical care','rhythmic'] }),
  makeCase('tilda',{ titleHU:'TIRDA ‚Äì tempor√°lis intermitt√°l√≥ ritmikus delta', titleEN:'TIRDA ‚Äì temporal intermittent rhythmic delta',
    montage:'Tempor√°lis', descHU:'Intermitt√°l√≥ ritmikus delta temporalisan.', descEN:'Intermittent rhythmic delta temporally.',
    explainHU:'Epileptog√©n tempor√°lis h√°l√≥zatra utal; gyakran oldalf√ºgg≈ë.', explainEN:'Suggests temporal epileptogenicity; often lateralized.',
    tipsHU:['Intermitt√°l√≥ csomagok','Tempor√°lis max','Epileptog√©n marker'], tipsEN:['Intermittent packets','Temporal max','Epileptogenic marker'],
    diff:'hard', label:'tirda',
    channels:['T3-T5','T5-O1','T4-T6','T6-O2'],
    spikesFn:()=>[200,350,500,650,800], magFn:()=>2,
    includeInQuiz:true, quizTargetHU:'ritmikus delta', quizTargetEN:'rhythmic delta', tags:['temporal','rhythmic'] }),
  makeCase('oirda',{ titleHU:'OIRDA ‚Äì occipitalis intermitt√°l√≥ ritmikus delta', titleEN:'OIRDA ‚Äì occipital intermittent rhythmic delta',
    montage:'Occipitalis', descHU:'Gyakran gyermekekn√©l; occipitalis dominancia.', descEN:'Often in children; occipital predominance.',
    explainHU:'Nem felt√©tlen epileptiform; kontextus alapj√°n √≠t√©lend≈ë.', explainEN:'Not necessarily epileptiform; interpret in context.',
    tipsHU:['Occipitalis max','Intermitt√°l√≥','Gyermekkor'], tipsEN:['Occipital max','Intermittent','Pediatric'],
    diff:'intermediate', label:'oirda',
    channels:['O1-O2','P3-O1','P4-O2'], spikesFn:()=>[180,360,540,720,900], magFn:()=>2,
    includeInQuiz:true, quizTargetHU:'OIRDA-szakaszok', quizTargetEN:'OIRDA segments', tags:['pediatric','rhythmic'] }),
  makeCase('firda',{ titleHU:'FIRDA ‚Äì front√°lis intermitt√°l√≥ ritmikus delta', titleEN:'FIRDA ‚Äì frontal intermittent rhythmic delta',
    montage:'Front√°lis', descHU:'Front√°lis dominancia, diff√∫z encephalopathia jele.', descEN:'Frontal predominance; sign of encephalopathy.',
    explainHU:'Nem epileptiform; ritmusos delta, front√°lis t√∫ls√∫llyal.', explainEN:'Non-epileptiform rhythmic delta with frontal predominance.',
    tipsHU:['Front√°lis max','Intermitt√°l√≥','K√≥ros h√°tt√©r'], tipsEN:['Frontal max','Intermittent','Abnormal background'],
    diff:'intermediate', label:'firda',
    channels:['F3-C3','Fz-Cz','F4-C4'], spikesFn:()=>[210,420,630,840], magFn:()=>2,
    includeInQuiz:true, quizTargetHU:'FIRDA-szakaszok', quizTargetEN:'FIRDA segments', tags:['encephalopathy','rhythmic'] }),
  makeCase('gpfa',{ titleHU:'GPFA ‚Äì generaliz√°lt paroxizm√°lis gyors aktivit√°s', titleEN:'GPFA ‚Äì generalized paroxysmal fast activity',
    montage:'Generaliz√°lt', descHU:'Gyors paroxizm√°lis aktivit√°s LGS-ben.', descEN:'Fast paroxysms typical in LGS.',
    explainHU:'Sz√©lesk√∂r≈± gyors roham-k√∂zeli mint√°zat; klinikum sz√ºks√©ges.', explainEN:'Diffuse fast near-ictal pattern; clinical context needed.',
    tipsHU:['Gyors ‚Äûburst√∂k‚Äù','Generaliz√°lt','LGS-asszoci√°ci√≥'], tipsEN:['Fast bursts','Generalized','LGS association'],
    diff:'expert', label:'gpfa',
    channels:['F3-C3','F4-C4','C3-P3','C4-P4'], spikesFn:()=>[300,305,310,315,600,605,610,615], magFn:()=>4,
    includeInQuiz:true, quizTargetHU:'GPFA-burst√∂k', quizTargetEN:'GPFA bursts', tags:['fast','generalized'] }),
  makeCase('sreda_like',{ titleHU:'SREDA-szer≈± aktivit√°s', titleEN:'SREDA-like activity',
    montage:'Parieto-tempor√°lis', descHU:'Ictal-imit√°tor id≈ësekn√©l.', descEN:'Ictal mimicker in elderly.',
    explainHU:'Ritmikus, de klinikum n√©lk√ºl ne min≈ës√≠tsd rohamnak.', explainEN:'Rhythmic but avoid labeling as seizure without clinical signs.',
    tipsHU:['Ictal-szer≈±, de benign is lehet','Klinikum d√∂nts√∂n','Topogr√°fia seg√≠t'], tipsEN:['Ictal-like yet benign possible','Let clinical context decide','Topography helps'],
    diff:'expert', label:'sreda-like',
    channels:['P3-O1','P4-O2','T3-T5','T4-T6'], spikesFn:()=>[200,400,600,800], magFn:()=>2,
    includeInQuiz:true, quizTargetHU:'SREDA-szakaszok', quizTargetEN:'SREDA segments', tags:['variant'] }),
  makeCase('breach',{ titleHU:'Breach-ritmus', titleEN:'Breach rhythm',
    montage:'Lok√°lis', descHU:'Csonthi√°ny felett fokozott gyors aktivit√°s.', descEN:'Fast activity over skull defect.',
    explainHU:'Nem epileptiform; m≈±t√©ti craniectomia felett gyakori.', explainEN:'Non-epileptiform; common over craniectomy sites.',
    tipsHU:['Fokozott gyors komponens','Lokaliz√°lt','Klinikai/anat√≥miai korrel√°tum'], tipsEN:['Increased fast','Localized','Anatomic correlation'],
    diff:'intermediate', label:'breach rhythm',
    channels:['C3-P3','F3-C3','C4-P4'], spikesFn:()=>[], magFn:()=>0, baseHz:18,
    includeInQuiz:false, quizTargetHU:'breach', quizTargetEN:'breach', tags:['variant'] }),
  makeCase('burst_supp',{ titleHU:'Burst-suppression', titleEN:'Burst-suppression',
    montage:'Referenci√°lis', descHU:'R√∂vid ‚Äûburst√∂k‚Äù hosszan elnyomott h√°tt√©ren.', descEN:'Short bursts on suppressed background.',
    explainHU:'Anoxia/aneszt√©zia; ar√°ny √©s evol√∫ci√≥ k√∂vetend≈ë.', explainEN:'Anoxia/anesthesia; track ratio and evolution.',
    tipsHU:['Nagyon alacsony alap','Szigetszer≈± burst√∂k','Klinikum kritikus'], tipsEN:['Very low baseline','Island-like bursts','Clinical picture critical'],
    diff:'hard', label:'burst-suppression',
    channels:['C3-P3','C4-P4','P3-O1','P4-O2'],
    spikesFn:(i)=>[120,130,131,400,410,411,700,710,711], magFn:()=>5, noise:0.2,
    includeInQuiz:true, quizTargetHU:'burst√∂k', quizTargetEN:'bursts', tags:['coma','anesthesia'] })
].map(materialize);

/* ============== Szinonim√°k / egyez√©s ============== */
const SYN = {
  "generalized spike-wave":["gsw","3hz","absence","generalizalt tuske hullam","generalized spike wave"],
  "polyspike-wave":["polyspike","polytuske","psw"],
  "left temporal spikes":["lt","bal temporalis","bal tempor√°lis","t3","t5","temp spikes"],
  "right temporal spikes":["rt","jobb temporalis","jobb tempor√°lis","t4","t6","temp spikes"],
  "triphasic waves":["triphasic","triphasicus","hepatic","metabolic encephalopathy"],
  "lpds":["lpd","lpds","pleds","pled","lateralized periodic discharges"],
  "gpds":["gpd","gpeds","generalized periodic discharges"],
  "lrda":["lrda"], "grda":["grda"], "sirpids":["sirpids","stimulus induced","stimulus-induced"],
  "right frontal spikes":["frontal spikes","jobb frontalis","jobb front√°lis","rf spikes"],
  "normal alpha":["normal","norm√°l","alfa","alpha","normal eeg","norm√°l alfa"],
  "mu rhythm":["mu","mu rhythm","sensorimotor"],
  "sleep spindles":["spindle","ors√≥","ors√≥k"],
  "k-complex":["k complex","k-komplex"], "vertex sharp":["vertex","v sharp"],
  "eye blink":["blink","eyeblink","pislog√°s","szemmozg√°s"], "emg":["emg","izomartefaktum","muscle"],
  "ecg artifact":["ecg","ekg","ekg artifact","ecg artifact"],
  "burst-suppression":["burst","suppression","bs"], "posts":["posts","positive occipital sharp transients"],
  "wicket spikes":["wicket","benign wicket"], "gpfa":["gpfa","fast paroxysmal"],
  "firda":["firda"], "oirda":["oirda"], "sreda-like":["sreda"], "breach rhythm":["breach"]
};
function normalize(s){
  return s.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^a-z0-9\s-]/g," ").replace(/\s+/g," ").trim();
}
function isSynonym(guess, canonical){
  const g=normalize(guess), c=normalize(canonical);
  if(g===c) return true;
  const list = SYN[canonical]||[];
  if(list.some(x=>normalize(x)===g)) return true;
  // r√©sz-egyez√©st is enged√ºnk (legal√°bb 4 karakter)
  const toks=g.split(" "); if(toks.some(t=>c.includes(t)&&t.length>=4)) return true;
  return false;
}

/* ============== √Ållapot ============== */
let mode='explore', showAns=true, playing=true, speed=1.0; let tExplore=0; let diffFilter='beginner';
let current=CASES[0], idCurrent=CASES[0], idFreeze=false, idOff=0;
let qCurrent=CASES.find(c=>c.includeInQuiz)||CASES[0], qFreeze=false, qShowAnswer=false, qOff=0, marks=[];
function rotatedIndex(i,off,N){ return ((i-off)%N + N) % N; }

/* ============== DOM seg√©dek ============== */
function byId(x){ return document.getElementById(x); }

/* ============== Sz√∂veg szinkron ============== */
function displayLabel(c){ return (LANG==='HU'?c.titleHU:c.titleEN); }
function syncMeta(){
  byId('meta').textContent = tK('caseMeta')(current.montage, diffName(current.diff), displayLabel(current));
  byId('desc').textContent = (LANG==='HU'?current.descHU:current.descEN);
  const tagDiv=byId('tags');
  tagDiv.innerHTML = (current.tags||[]).map(x=>`<span class="chip">${trTag(x)}</span>`).join(' ');
  byId('explain').textContent = (LANG==='HU'?current.explainHU:current.explainEN);
  const tips=(LANG==='HU'?current.tipsHU:current.tipsEN); const ul=byId('tips'); ul.innerHTML='';
  tips.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
}
function syncTask(){
  const txt = LANG==='HU' ? qCurrent.quizTargetHU : qCurrent.quizTargetEN;
  byId('task').textContent = tK('task')(txt||'events');
  const has = quizTotal()>0;
  const ne=byId('noEvents'); ne.style.display=has?'none':'block'; ne.textContent=tK('noEvents');
}
function syncTexts(){
  byId('tabExplore').textContent=tK('explore');
  byId('tabIdentify').textContent=tK('identify');
  byId('tabQuiz').textContent=tK('quiz');
  byId('tabLessons').textContent=tK('lessons');
  byId('solutionLbl').textContent=tK('solution');
  byId('ansLbl').textContent=showAns?tK('on'):tK('off');
  byId('speedLbl').textContent=tK('speed');
  byId('spdLbl').textContent=speed.toFixed(1)+'√ó';
  byId('explainHdr').textContent=tK('details');
  byId('tipsHdr').textContent=tK('tips');
  byId('newIdentify').textContent=tK('newTask');
  byId('freezeIdentify').textContent=tK('freeze');
  byId('hintBtn').textContent=tK('hint');
  byId('guess').placeholder=tK('guessPH');
  byId('check').textContent=tK('check');
  byId('resetQuiz').textContent=tK('reset');
  byId('freezeQuiz').textContent=tK('freeze');
  byId('snapshotQuiz').textContent=tK('nextSnap');
  byId('showSolution').textContent=tK('solution')+' + XP';
  byId('scoreHdr').textContent=tK('score');
  byId('hitLbl').childNodes[0].textContent=tK('hits')+': ';
  byId('totalLbl').textContent=tK('total');
  byId('bestLbl').textContent=tK('best');
  byId('medalHdr').textContent=tK('medals');
  byId('footerTxt').textContent=tK('footer');
  byId('langBtn').textContent=LANG+' ‚ñæ';
  byId('miniQuizHdr').textContent=tK('miniQuiz');
  byId('lqInstr').textContent=tK('selectAll');
  byId('lqSubmit').textContent=tK('submit');
  syncMeta(); syncTask(); refreshMeta();
}

/* ============== Tabok ============== */
function setTab(tab){
  mode=tab;
  byId('tabExplore').className = tab==='explore'?'primary':'ghost';
  byId('tabIdentify').className = tab==='identify'?'primary':'ghost';
  byId('tabQuiz').className   = tab==='quiz'?'primary':'ghost';
  byId('tabLessons').className= tab==='lessons'?'primary':'ghost';
  byId('explore').classList.toggle('hidden',tab!=='explore');
  byId('identify').classList.toggle('hidden',tab!=='identify');
  byId('quiz').classList.toggle('hidden',tab!=='quiz');
  byId('lessons').classList.toggle('hidden',tab!=='lessons');
}
byId('tabExplore').onclick=()=>setTab('explore');
byId('tabIdentify').onclick=()=>setTab('identify');
byId('tabQuiz').onclick=()=>setTab('quiz');
byId('tabLessons').onclick=()=>setTab('lessons');

/* ============== Explore UI ============== */
const caseSel=byId('caseSel');
function refreshCaseOptions(){
  caseSel.innerHTML='';
  CASES.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=displayLabel(c); caseSel.appendChild(o); });
  caseSel.value=current.id;
}
caseSel.onchange=()=>{ current=CASES.find(c=>c.id===caseSel.value); syncMeta(); };
byId('toggleAns').onclick=()=>{ showAns=!showAns; byId('ansLbl').textContent=showAns?tK('on'):tK('off'); };
byId('playBtn').onclick=()=>{ playing=!playing; byId('playBtn').textContent= playing?'‚èØÔ∏è '+tK('pause'):'‚ñ∂Ô∏è '+tK('play'); };
byId('speed').oninput=(e)=>{ speed=parseFloat(e.target.value); byId('spdLbl').textContent=speed.toFixed(1)+'√ó'; };

/* ============== Identify ============== */
const difficulty=byId('difficulty'); const idfMeta=byId('idfMeta'); const guess=byId('guess'); const fb=byId('fb');
function buildDifficulty(){
  const opts=[['beginner',tK('beginner')],['intermediate',tK('intermediate')],['hard',tK('hard')],['expert',tK('expert')],['all',tK('all')]];
  difficulty.innerHTML=''; opts.forEach(([v,txt])=>{ const o=document.createElement('option'); o.value=v; o.textContent=txt; difficulty.appendChild(o); });
  difficulty.value=diffFilter;
}
difficulty.onchange=()=>{ diffFilter=difficulty.value; };
byId('newIdentify').onclick=()=>idRandomCase();
byId('freezeIdentify').onclick=()=>{ idFreeze=!idFreeze; if(!idFreeze) idOff=0; };
byId('hintBtn').onclick=()=>{ const initials=idCurrent.label.split(' ').map(w=>w[0].toUpperCase()).join(''); fb.classList.remove('hidden','no'); fb.classList.add('ok'); fb.textContent=tK('hintText')+initials; };
byId('check').onclick=handleIdentify;

function filteredCases(){ if(diffFilter==='all') return CASES; return CASES.filter(c=>c.diff===diffFilter || (diffFilter==='expert'&&c.diff==='expert')); }
function idRandomCase(){
  const arr=filteredCases(); idCurrent=arr[Math.floor(Math.random()*arr.length)];
  idfMeta.textContent=tK('idfMeta')(diffName(idCurrent.diff), idCurrent.montage);
  guess.value=''; fb.className='kudos hidden'; fb.textContent='';
}
idRandomCase();
function handleIdentify(){
  const g=guess.value.trim(); if(!g) return;
  const ok = isSynonym(g, idCurrent.label);
  fb.classList.remove('hidden'); fb.classList.add(ok?'ok':'no');
  fb.textContent = ok ? tK('correct') : (tK('wrong')+idCurrent.label);
  awardXP(ok?20:2); if(ok){ STREAK++; setTimeout(()=>{ idRandomCase(); refreshMeta(); }, 900); } else { STREAK=0; refreshMeta(); } saveProgress();
}

/* ============== Quiz ============== */
const caseSelQ=byId('caseSelQ');
function refreshCaseOptionsQ(){
  caseSelQ.innerHTML='';
  CASES.filter(c=>c.includeInQuiz).forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=displayLabel(c); caseSelQ.appendChild(o); });
  caseSelQ.value=qCurrent.id;
}
caseSelQ.onchange=()=>{ qCurrent=CASES.find(c=>c.id===caseSelQ.value); marks=[]; qShowAnswer=false; qOff=0; syncQuizMeta(); syncTask(); };
byId('resetQuiz').onclick=()=>{ marks=[]; qShowAnswer=false; qOff=0; syncQuizMeta(); };
byId('freezeQuiz').onclick=()=>{ qFreeze=!qFreeze; if(!qFreeze) qOff=0; };
byId('snapshotQuiz').onclick=()=>{ qFreeze=true; qOff=Math.floor(Math.random()*(qCurrent.sampleRate-1)); syncQuizMeta(); };
byId('showSolution').onclick=()=>{ qShowAnswer=true; const pct=quizPct(); awardXP(pct>=80?40:15); BEST=Math.max(BEST,pct); saveProgress(); refreshMeta(); };
byId('eeg3').addEventListener('click',(e)=>{
  if(mode!=='quiz') return; const r=e.target.getBoundingClientRect();
  const x=(e.clientX-r.left)*devicePixelRatio, y=(e.clientY-r.top)*devicePixelRatio;
  marks.push({x,y}); syncQuizMeta();
});
function quizTotal(){ return qCurrent.channels.reduce((a,ch)=>a+(ch.spikes?.length||0),0); }
function quizHits(off=0){
  const dx=70*devicePixelRatio; // nagyvonal√∫ tal√°lati ablak
  const xScale=(byId('eeg3').width / qCurrent.sampleRate);
  let correct=0; qCurrent.channels.forEach(ch=> ch.spikes.forEach(sx=>{
    const pos=rotatedIndex(sx,off,qCurrent.sampleRate); const sxpx=pos*xScale;
    if(marks.some(m=>Math.abs(m.x-sxpx)<dx)) correct++;
  })); return correct;
}
function quizPct(){ const t=quizTotal(); const h=quizHits(qOff); return t?Math.round(h/t*100):0; }
function syncQuizMeta(){ byId('total').textContent=String(quizTotal()); byId('hits').textContent=String(quizHits(qOff)); const p=quizPct(); byId('pct').textContent=p+'%'; byId('bar').style.width=p+'%'; }

/* ============== Leck√©k: 3√ó10 ============== */
const LESSONS = (()=>{ // 10-10-10 elt√©r≈ë lecke
  const B = [
    ['artifact_vs_spike','Artefaktum vs spike','Artifact vs spike',
      [['Artefaktum: szemmozg√°s/pislog√°s front√°lis dominanci√°val, nem hegyes.','Artifact: eye blink frontal predominance, not sharp.'],
       ['Spike: meredek fel/le, gyakran lass√∫ hull√°m k√∂veti.','Spike: steep up/down, often with slow wave.']],
      {qHU:'Melyik tipikus EMG-re?', qEN:'Which is typical for EMG?', choices:[['Sz√©less√°v√∫ zaj','Broadband noise',true,5],['3 Hz SW p√°rok','3 Hz SW pairs',false,0],['Triphasic hull√°mok','Triphasic waves',false,0]]}],
    ['benign_variants','Benign vari√°nsok','Benign variants',
      [['Wicket spike: tempor√°lis, benignus.','Wicket spikes: temporal, benign.'],
       ['POSTS: pozit√≠v occipitalis √©les alv√°sban.','POSTS: positive occipital sharp in sleep.']],
      {qHU:'Jel√∂ld a benign vari√°nsokat!', qEN:'Mark the benign variants!', choices:[['Wicket spikes','Wicket spikes',true,5],['POSTS','POSTS',true,5],['LPDs','LPDs',false,0]]}],
    ['sleep_basics','Alv√°s alapok','Sleep basics',
      [['N1: vertex √©lesek megjelenhetnek.','N1: vertex sharps may appear.'],['N2: ors√≥k + K-komplex.','N2: spindles + K-complex.']],
      {qHU:'Melyik N2-re jellemz≈ë?', qEN:'Characteristic of N2?', choices:[['K-komplex','K-complex',true,6],['Mu-ritmus','Mu rhythm',false,0],['Ors√≥k','Spindles',true,6]]}],
    ['normal_alpha','Norm√°l alfa','Normal alpha',
      [['8‚Äì10 Hz occipitalis, reakt√≠v szemnyit√°sra.','8‚Äì10 Hz occipital, reactive to eye opening.']],
      {qHU:'Jel√∂ld a norm√°l jeleket!','EN':'Select normal findings!', choices:[['Reakt√≠v alfa','Reactive alpha',true,5],['Generaliz√°lt t√ºske-hull√°m','Generalized spike‚Äìwave',false,0],['Szimmetria','Symmetry',true,5]]}],
    ['artifact_suite','Artefaktumok','Artifacts',
      [['Pislog√°s: front√°lis lass√∫ deflexi√≥.','Blink: frontal slow deflection.'],['ECG: ritmikus, id≈ëz√≠tett cs√∫csok.','ECG: rhythmic time-locked peaks.']],
      {qHU:'Melyik artefaktum?', qEN:'Which is an artifact?', choices:[['ECG-peak','ECG peak',true,5],['LPDs','LPDs',false,0],['EMG','EMG',true,5]]}],
    ['firda_oirda','FIRDA vs OIRDA','FIRDA vs OIRDA',
      [['FIRDA: front√°lis, encephalopathia.','FIRDA: frontal, encephalopathy.'],['OIRDA: occipitalis, gyermekek.','OIRDA: occipital, children.']],
      {qHU:'P√°ros√≠tsd a lokaliz√°ci√≥t!', qEN:'Match the location!', choices:[['FIRDA‚Üífront√°lis','FIRDA‚Üífrontal',true,6],['OIRDA‚Üíoccipitalis','OIRDA‚Üíoccipital',true,6],['OIRDA‚Üífront√°lis','OIRDA‚Üífrontal',false,0]}],
    ['tempo_spikes','Tempor√°lis t√ºsk√©k','Temporal spikes',
      [['T3/T5 max bal f√≥kuszn√°l.','T3/T5 max in left focus.']],
      {qHU:'Mi emeli az epileptiform gyan√∫t?','EN':'What supports epileptiform nature?', choices:[['Meredek keskeny cs√∫cs','Steep narrow peak',true,6],['Sima lass√∫ domborulat','Smooth slow hump',false,0],['Lass√∫ hull√°m k√≠s√©ret','Associated slow wave',true,6]]}],
    ['gsw_basics','3 Hz SW alapok','3 Hz SW basics',
      [['Spike + lass√∫ hull√°m 2.5‚Äì3.5 Hz.','Spike + slow wave 2.5‚Äì3.5 Hz.']],
      {qHU:'Jel√∂ld a helyes √°ll√≠t√°sokat!','EN':'Mark correct statements!', choices:[['Generaliz√°lt √©s szinkron','Generalized and synchronous',true,6],['Artefaktum','Artifact',false,0],['K√≠s√©rhet absence','May underlie absence',true,6]]}],
    ['triphasic_core','Triphasic mag','Triphasic core',
      [['H√°rom f√°zis, front√°lis t√∫ls√∫ly, nem epileptiform.','Three phases, frontal predominance, non-epileptiform.']],
      {qHU:'Mi NEM igaz triphasic-ra?','EN':'What is NOT true for triphasic?', choices:[['Mindig ictalis','Always ictal',false,0],['Front√°lis dominancia gyakori','Frontal predominance common',true,6],['H√°rom f√°zis','Three phases',true,6]]}],
    ['sirpids_key','SIRPIDs kulcs','SIRPIDs key',
      [['Stimulus-kapcsolt aktivit√°s.','Stimulus-linked activity.']],
      {qHU:'V√°laszd ki a SIRPIDs jellemz≈ëit!','EN':'Pick SIRPIDs features!', choices:[['Stimulus ut√°n jelenik meg','Appears after stimulus',true,8],['Generaliz√°lt 3 Hz','Generalized 3 Hz',false,0],['Ritmikus/periodikus','Rhythmic/periodic',true,6]]}]
  ];
  const I = [
    ['artifact_harder','Artefaktum differenci√°l√°s','Artifact differentiation',
      [['EMG vs spike: sz√©less√°v√∫ vs keskeny.','EMG vs spike: broadband vs narrow.']],
      {qHU:'Mi EMG?','EN':'Which is EMG?', choices:[['Sz√©less√°v√∫ inkoherens','Broadband incoherent',true,8],['Keskeny hegyes','Narrow sharp',false,0]]}],
    ['temporal_vs_frontal','Tempor√°lis vs front√°lis','Temporal vs frontal',
      [['Topogr√°fia seg√≠t a lateraliz√°ci√≥ban.','Topography helps lateralization.']],
      {qHU:'Melyik front√°lis?','EN':'Which are frontal?', choices:[['FIRDA','FIRDA',true,6],['OIRDA','OIRDA',false,0],['Front√°lis spikes','Frontal spikes',true,6]]}],
    ['ictal_growth','Ictalis evol√∫ci√≥','Ictal evolution',
      [['Ictalis mint√°zat frekvencia/amplit√∫d√≥ n√∂veked√©ssel evolv√°l.','Ictal pattern evolves with frequency/amplitude increase.']],
      {qHU:'Mi jelzi az ictust?','EN':'What indicates ictus?', choices:[['Evol√∫ci√≥','Evolution',true,8],['Statikus periodicit√°s','Static periodicity',false,0]]}],
    ['tirda_lrda','TIRDA vs LRDA','TIRDA vs LRDA',
      [['TIRDA tempor√°lis, intermitt√°l√≥.','TIRDA temporal, intermittent.']],
      {qHU:'TIRDA jellemz≈ëk?','EN':'TIRDA features?', choices:[['Tempor√°lis','Temporal',true,6],['Occipitalis','Occipital',false,0],['Intermitt√°l√≥','Intermittent',true,6]]}],
    ['gpfa_lgs','GPFA √©s LGS','GPFA and LGS',
      [['GPFA gyors paroxizmusok LGS-ben.','GPFA fast paroxysms in LGS.']],
      {qHU:'GPFA‚Ä¶','EN':'GPFA is‚Ä¶', choices:[['Gyors paroxizmus','Fast paroxysms',true,8],['Delta lassul√°s','Delta slowing',false,0]]}],
    ['ecg_vs_spike','EKG vs spike','ECG vs spike',
      [['EKG id≈ëz√≠tett, csatorna-f√ºggetlen.','ECG time-locked, channel-independent.']],
      {qHU:'V√°laszd az EKG-t!','EN':'Pick ECG!', choices:[['Id≈ëz√≠tett cs√∫csok','Time-locked peaks',true,6],['Later√°lis spikes','Lateralized spikes',false,0]]}],
    ['posts_wicket','POSTS vs Wicket','POSTS vs Wicket',
      [['Mind benign, de lokaliz√°ci√≥ elt√©r.','Both benign; localization differs.']],
      {qHU:'POSTS hol?','EN':'Where are POSTS?', choices:[['Occipitalis','Occipital',true,6],['Front√°lis','Frontal',false,0],['Tempor√°lis','Temporal',false,0]]}],
    ['grda_enceph','GRDA √©s encephalopathia','GRDA and encephalopathy',
      [['GRDA gyakran metabolikus ok.','GRDA often metabolic.']],
      {qHU:'GRDA-hoz t√°rsul?','EN':'Associated with GRDA?', choices:[['Encephalopathia','Encephalopathy',true,6],['Absence roham','Absence seizure',false,0]]}],
    ['sirpids_decision','SIRPIDs d√∂nt√©s','SIRPIDs decision',
      [['IIC spektrum; klinikum d√∂nt.','On IIC; clinical context matters.']],
      {qHU:'Mit teszel SIRPIDs-n√©l?','EN':'What to do for SIRPIDs?', choices:[['Stimulus-kontroll','Control stimuli',true,6],['Azonnali AED mindenkin√©l','Immediate AED for all',false,0]]}],
    ['lpds_management','LPDs menedzsment','LPDs management',
      [['LPDs akut laesi√≥val t√°rsulhat.','LPDs often with acute lesion.']],
      {qHU:'Mi fontos?','EN':'What matters?', choices:[['Klinikai korrel√°tum','Clinical correlation',true,8],['Mindig benignus','Always benign',false,0]]}]
  ];
  const E = [
    ['burst_supp_depth','Burst-supp m√©lys√©g','Burst-supp depth',
      [['Burst ar√°ny √©s h√°tt√©r elnyom√°s √©rt√©kelend≈ë.','Assess burst ratio and suppression.']],
      {qHU:'Mi jelez s√∫lyoss√°got?','EN':'What indicates severity?', choices:[['Hossz√∫ elnyom√°s','Long suppression',true,10],['B≈ës√©ges GPFA','Abundant GPFA',false,0]]}],
    ['sreda_pitfall','SREDA buktat√≥','SREDA pitfall',
      [['Ictal-imit√°tor; klinikum n√©lk√ºl ne mondj rohamot.','Ictal mimicker; avoid calling seizure without clinical correlation.']],
      {qHU:'Mit NEM teszel?','EN':'What NOT to do?', choices:[['Automatikus roham-diagn√≥zis','Auto seizure label',false,0],['Klinikum ellen≈ërz√©se','Check clinical context',true,8]]}],
    ['gpfa_vs_sw','GPFA vs SW','GPFA vs SW',
      [['GPFA gyors; nem 3 Hz SW.','GPFA fast; not 3 Hz SW.']],
      {qHU:'Jel√∂ld a GPFA-t!','EN':'Mark GPFA!', choices:[['Gyors paroxizmusok','Fast paroxysms',true,8],['3 Hz spike‚Äìwave','3 Hz spike‚Äìwave',false,0]]}],
    ['ictal_localization','Ictus lokaliz√°ci√≥','Ictal localization',
      [['Id≈ëbeli/t√©rbeli evol√∫ci√≥ seg√≠t a f√≥kuszban.','Temporal/spatial evolution localizes focus.']],
      {qHU:'Mi seg√≠t?','EN':'What helps?', choices:[['Fejl≈ëd≈ë ritmus','Evolving rhythm',true,8],['Statikus GRDA','Static GRDA',false,0]]}],
    ['ncse_spectrum','NCSE spektrum','NCSE spectrum',
      [['LPDs/GRDA/SIRPIDs √©rt√©kel√©se IIC-ben.','Interpret LPDs/GRDA/SIRPIDs on IIC.']],
      {qHU:'Mi tol NCSE fel√©?','EN':'Pushes toward NCSE?', choices:[['LPDs klinikai v√°ltoz√°ssal','LPDs with clinical change',true,10],['Benign POSTS','Benign POSTS',false,0]]}],
    ['breach_reading','Breach olvas√°s','Reading breach',
      [['Gyors aktivit√°s hi√°nyz√≥ koponyacsont felett.','Fast activity over skull defect.']],
      {qHU:'Breach jele?','EN':'Sign of breach?', choices:[['Magas gyors aktivit√°s','High fast activity',true,8],['Generaliz√°lt delta','Generalized delta',false,0]]}],
    ['temporal_networks','Tempor√°lis h√°l√≥zatok','Temporal networks',
      [['Anterior vs posterior tempor√°lis k√ºl√∂nbs√©gek.','Anterior vs posterior temporal differences.']],
      {qHU:'Posterior tempor√°lis max?','EN':'Posterior temporal max?', choices:[['T5/T6','T5/T6',true,8],['F3/F4','F3/F4',false,0]]}],
    ['ictal_artifact','Ictus vs artefaktum','Ictal vs artifact',
      [['EMG/ECG elk√ºl√∂n√≠t√©se sz√ºks√©ges.','Differentiate EMG/ECG.']],
      {qHU:'Artefaktum p√©lda?','EN':'Example of artifact?', choices:[['EKG-hez id≈ëz√≠tett cs√∫cs','Peaks time-locked to ECG',true,8],['Evolv√°l√≥ ritmus','Evolving rhythm',false,0]]}],
    ['advanced_localizers','Halad√≥ lokaliz√°torok','Advanced localizers',
      [['TIRDA/GPFA jelent≈ës√©ge.','Significance of TIRDA/GPFA.']],
      {qHU:'TIRDA‚Ä¶','EN':'TIRDA‚Ä¶', choices:[['Tempor√°lis rizik√≥jel','Temporal risk marker',true,8],['Front√°lis benign','Frontal benign',false,0]]}],
    ['burst_metrics','Burst-metrik√°k','Burst metrics',
      [['Ar√°ny, hosszak, variancia.','Ratios, lengths, variance.']],
      {qHU:'Mit m√©rsz?','EN':'What do you measure?', choices:[['Burst/suppression ar√°ny','Burst/suppression ratio',true,10],['Csak alfa frekvencia','Only alpha frequency',false,0]]}]
  ];
  function mk(level,arr){
    return arr.map(([id,hu,en,steps,q])=>({
      id, level, titleHU:hu, titleEN:en,
      steps:steps.map(([huS,enS])=>({htmlHU:huS, htmlEN:enS})),
      quiz:{ qHU:q.qHU||q.qHU, qEN:q.qEN||q.qEN, choices:q.choices.map(([huC,enC,ok,xp])=>({hu:huC,en:enC,ok,xp})) }
    }));
  }
  return [...mk('beginner',B), ...mk('intermediate',I), ...mk('expert',E)];
})();

const lessonLevelSel=byId('lessonLevel'); const lessonSel=byId('lessonSel');
function refreshLessons(){
  const levels=[['beginner',tK('lessonsBeginner')],['intermediate',tK('lessonsIntermediate')],['expert',tK('lessonsExpert')],['all',tK('all')]];
  lessonLevelSel.innerHTML=''; levels.forEach(([v,txt])=>{ const o=document.createElement('option'); o.value=v; o.textContent=txt; lessonLevelSel.appendChild(o); });
  if(!lessonLevelSel.value) lessonLevelSel.value='beginner';
  const lvl=lessonLevelSel.value;
  const list=LESSONS.filter(L=> lvl==='all' || L.level===lvl);
  lessonSel.innerHTML=''; list.forEach(L=>{ const o=document.createElement('option'); o.value=L.id; o.textContent=(LANG==='HU'?L.titleHU:L.titleEN); lessonSel.appendChild(o); });
}
lessonLevelSel.onchange=refreshLessons;
function renderLesson(id){
  const L=LESSONS.find(x=>x.id===id); const body=byId('lessonBody'); body.innerHTML='';
  L.steps.forEach(step=>{ const card=document.createElement('div'); card.className='card'; card.innerHTML=(LANG==='HU'?step.htmlHU:step.htmlEN); body.appendChild(card); });
  const q=byId('lessonQuiz'); q.classList.remove('hidden');
  byId('lqQ').textContent=(LANG==='HU'?L.quiz.qHU:L.quiz.qEN);
  const choices=byId('lqChoices'); choices.innerHTML='';
  L.quiz.choices.forEach((c,i)=>{
    const wrap=document.createElement('label'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='8px';
    const cb=document.createElement('input'); cb.type='checkbox'; const txt=document.createElement('span'); txt.textContent=(LANG==='HU'?c.hu:c.en);
    wrap.appendChild(cb); wrap.appendChild(txt); choices.appendChild(wrap);
  });
  byId('lqSubmit').onclick=()=>{
    let gained=0, best=0; const cbs=choices.querySelectorAll('input');
    L.quiz.choices.forEach((c,i)=>{ best+= (c.ok?c.xp:0); if(cbs[i].checked && c.ok) gained+=c.xp; });
    const fb=byId('lqFb'); fb.classList.remove('hidden'); fb.classList.add('ok'); fb.textContent=tK('gained')+gained+' ‚Ä¢ '+tK('bestPossible')+best;
    if(gained>0) awardXP(gained);
  };
}
byId('startLesson').onclick=()=> renderLesson(lessonSel.value);

/* ============== Rajzol√°s ============== */
function fitCanvas(c){ const w=c.clientWidth*devicePixelRatio, h=c.clientHeight*devicePixelRatio; if(c.width!==w||c.height!==h){ c.width=w; c.height=h; } }
function toXY(c,i,yVal,idx,chCount,sampleRate){ const xScale=c.width/sampleRate; const chGap=(c.height-40)/chCount; const yBase=20+idx*chGap+chGap/2; const yScale=12*devicePixelRatio; return {x:i*xScale,y:yBase-yVal*yScale,yBase,chGap}; }

function drawExplore(){
  const canvas=byId('eeg'); fitCanvas(canvas); if(playing){ tExplore=(tExplore+0.06*speed)%current.sampleRate; }
  const off=Math.floor(tExplore); const ctx=canvas.getContext('2d'); ctx.fillStyle='#0b0f1a'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='#142038'; ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<canvas.height;y+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  ctx.lineWidth=2;
  current.channels.forEach((ch,idx)=>{
    const rotated=ch.data.slice(off).concat(ch.data.slice(0,off));
    ctx.strokeStyle='#dbe5ff'; ctx.beginPath();
    rotated.forEach((v,i)=>{ const p=toXY(canvas,i,v,idx,current.channels.length,current.sampleRate); if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    ctx.stroke();
    const p0=toXY(canvas,0,0,idx,current.channels.length,current.sampleRate);
    ctx.fillStyle='#93a3c8'; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.fillText(ch.name, 10*devicePixelRatio, p0.yBase - p0.chGap/2 + 14*devicePixelRatio);
    if(showAns){
      ctx.strokeStyle='#ff4d4d'; ctx.lineWidth=3; ch.spikes.forEach(sx=>{
        const pos=rotatedIndex(sx,off,current.sampleRate); const x=pos*(canvas.width/current.sampleRate); const y=p0.yBase - rotated[pos]*(12*devicePixelRatio);
        ctx.beginPath(); ctx.arc(x,y,16*devicePixelRatio,0,Math.PI*2); ctx.stroke();
      });
    }
  });
  requestAnimationFrame(drawExplore);
}
requestAnimationFrame(drawExplore);

function drawIdentify(){
  const canvas=byId('eeg2'); fitCanvas(canvas); const ctx=canvas.getContext('2d');
  if(!idFreeze){ idOff=Math.floor((performance.now()*0.06*speed)%idCurrent.sampleRate); }
  const off=idOff;
  ctx.fillStyle='#0b0f1a'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='#142038'; ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<canvas.height;y+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(x=canvas.width,y); ctx.stroke(); }
  ctx.lineWidth=2;
  idCurrent.channels.forEach((ch,idx)=>{
    const rotated=ch.data.slice(off).concat(ch.data.slice(0,off));
    ctx.strokeStyle='#dbe5ff'; ctx.beginPath();
    rotated.forEach((v,i)=>{ const p=toXY(canvas,i,v,idx,idCurrent.channels.length,idCurrent.sampleRate); if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    ctx.stroke();
    const p0=toXY(canvas,0,0,idx,idCurrent.channels.length,idCurrent.sampleRate);
    ctx.fillStyle='#93a3c8'; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.fillText(ch.name, 10*devicePixelRatio, p0.yBase - p0.chGap/2 + 14*devicePixelRatio);
  });
  requestAnimationFrame(drawIdentify);
}
requestAnimationFrame(drawIdentify);

function drawQuiz(){
  const canvas=byId('eeg3'); fitCanvas(canvas); const ctx=canvas.getContext('2d');
  if(!qFreeze){ qOff=Math.floor((performance.now()*0.06*speed)%qCurrent.sampleRate); }
  const off=qOff; ctx.fillStyle='#0b0f1a'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='#142038'; ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<canvas.height;y+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  ctx.lineWidth=2;
  qCurrent.channels.forEach((ch,idx)=>{
    const rotated=ch.data.slice(off).concat(ch.data.slice(0,off));
    ctx.strokeStyle='#dbe5ff'; ctx.beginPath();
    rotated.forEach((v,i)=>{ const p=toXY(canvas,i,v,idx,qCurrent.channels.length,qCurrent.sampleRate); if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    ctx.stroke();
    const p0=toXY(canvas,0,0,idx,qCurrent.channels.length,qCurrent.sampleRate);
    ctx.fillStyle='#93a3c8'; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.fillText(ch.name, 10*devicePixelRatio, p0.yBase - p0.chGap/2 + 14*devicePixelRatio);
    if(qShowAnswer){
      ctx.strokeStyle='#ff4d4d'; ctx.lineWidth=3; ch.spikes.forEach(sx=>{
        const pos=rotatedIndex(sx,off,qCurrent.sampleRate); const x=pos*(canvas.width/qCurrent.sampleRate); const y=p0.yBase - rotated[pos]*(12*devicePixelRatio);
        ctx.beginPath(); ctx.arc(x,y,16*devicePixelRatio,0,Math.PI*2); ctx.stroke();
      });
    }
  });
  // a j√°t√©kos kattint√°sai ‚Äì nagyobb jel√∂l√©s
  ctx.strokeStyle='#60a5fa'; ctx.lineWidth=3;
  marks.forEach(m=>{ ctx.beginPath(); ctx.arc(m.x,m.y,18*devicePixelRatio,0,Math.PI*2); ctx.stroke(); });
  const pct=quizPct(); const hits=quizHits(off);
  byId('hits').textContent=String(hits); byId('pct').textContent=pct+'%'; byId('bar').style.width=pct+'%';
  requestAnimationFrame(drawQuiz);
}
requestAnimationFrame(drawQuiz);

/* ============== Esem√©nyek ============== */
byId('langBtn').onclick=()=> setLang(LANG==='HU'?'EN':'HU');
document.addEventListener('keydown',(e)=>{
  if(e.key===' '){
    if(mode==='explore'){ playing=!playing; byId('playBtn').textContent= playing?'‚èØÔ∏è '+tK('pause'):'‚ñ∂Ô∏è '+tK('play'); }
    if(mode==='identify'){ idFreeze=!idFreeze; }
    if(mode==='quiz'){ qFreeze=!qFreeze; }
    e.preventDefault();
  }
  if(e.key==='ArrowRight'){ speed=Math.min(5, speed+0.1); byId('speed').value=String(speed); byId('spdLbl').textContent=speed.toFixed(1)+'√ó'; }
  if(e.key==='ArrowLeft'){ speed=Math.max(0.5, speed-0.1); byId('speed').value=String(speed); byId('spdLbl').textContent=speed.toFixed(1)+'√ó'; }
});

/* ============== Init + kis √∂nellen≈ërz√©s ============== */
function init(){
  refreshCaseOptions(); refreshCaseOptionsQ(); buildDifficulty(); refreshLessons();
  syncTexts(); setTab('explore');
  try{
    console.assert(typeof quizTotal()==='number','quizTotal should return number');
    console.assert(document.getElementById('lessonSel'),'lessonSel missing');
  }catch(e){ console.error('Self-test',e); }
}
init();
</script>
</body>
</html>
