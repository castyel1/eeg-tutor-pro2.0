<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>EEG Tutor ‚Äì Pro v1.9.4 (GitHub fixes)</title>
<style>
  :root{ --bg:#0f1115; --card:#151923; --muted:#9aa3b2; --text:#e8ecf1; --accent:#6ee7ff; --accent2:#a78bfa; --good:#22c55e; --bad:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:var(--text);}
  header{padding:14px 16px; display:flex; align-items:center; justify-content:space-between; background:linear-gradient(180deg,#121726,#0f1115)}
  h1{font-size:18px; margin:0; font-weight:700; letter-spacing:.3px}
  .badge{font-size:11px; color:#cbd5e1; border:1px solid #334155; padding:2px 8px; border-radius:999px; margin-left:8px}
  .row{display:flex; align-items:center; gap:10px}
  .container{padding:12px; display:grid; gap:12px; max-width:1240px; margin:0 auto}
  .card{background:var(--card); border:1px solid #1f2432; border-radius:16px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,.2)}
  .controls{display:flex; gap:8px; flex-wrap:wrap}
  select, button, input[type='text']{background:#0f1320; color:var(--text); border:1px solid #232a3b; border-radius:12px; padding:10px 12px; font-size:14px}
  button{background:#0f1320; cursor:pointer}
  button.primary{background:linear-gradient(180deg,#1b2a4a,#15223d); border-color:#2b395a}
  button.ghost{background:transparent; border-color:#2b3346}
  .muted{color:var(--muted); font-size:13px}
  .grid{display:grid; gap:10px}
  .two{grid-template-columns:1fr 1fr}
  .hidden{display:none}
  .pill{padding:4px 8px; border:1px solid #2a3347; border-radius:999px; font-size:12px; color:#cbd5e1}
  .score{font-weight:700}
  canvas{width:100%; height:300px; background:#0b0f1a; border-radius:14px; border:1px solid #1e2434; touch-action:manipulation}
  .tabs{display:flex; gap:8px}
  .tabs button{flex:1}
  .progress{height:10px; background:#101525; border:1px solid #1e2434; border-radius:999px; overflow:hidden}
  .progress>div{height:100%; background:linear-gradient(90deg,#22c55e,#84cc16); width:0%}
  .footer{padding:10px; font-size:11px; color:#8b93a7; text-align:center}
  .kudos{font-size:13px; padding:6px 10px; border-radius:10px}
  .ok{background:#052e1b; border:1px solid #0b6b3f; color:#c7f9d4}
  .no{background:#3a0a0a; border:1px solid #7f1d1d; color:#fecaca}
  .small{font-size:11px; color:#9aa3b2}
  .lang{cursor:pointer; user-select:none}
  .section-title{font-weight:700; margin-bottom:6px}
  .chip{font-size:11px; border:1px solid #2a3347; border-radius:999px; padding:2px 6px; color:#cbd5e1}
  #errorBanner{display:none; position:fixed; left:0; right:0; bottom:0; background:#7f1d1d; color:#fff; padding:8px 12px; font-size:12px; z-index:99}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>EEG Tutor</h1>
    <span class="badge">Pro v1.9.4 ‚Ä¢ Single-file</span>
  </div>
  <div class="row">
    <span class="pill lang" id="langBtn">HU ‚ñæ</span>
    <span class="pill"><span id="lvl">1</span> <span id="lvlLbl">Szint</span></span>
    <span class="pill"><span id="xp">0</span> <span id="xpLbl">XP</span></span>
  </div>
</header>

<div class="container">
  <div class="card">
    <div class="tabs">
      <button id="tabExplore" class="primary">Explore</button>
      <button id="tabIdentify" class="ghost">Identify</button>
      <button id="tabQuiz" class="ghost">Quiz</button>
      <button id="tabLessons" class="ghost">Lessons</button>
    </div>
  </div>

  <!-- Explore -->
  <div class="card" id="explore">
    <div class="controls" style="margin-top:10px">
      <select id="caseSel"></select>
      <button id="toggleAns" class="ghost"><span id="solutionLbl">Megold√°s</span>: <span id="ansLbl">be</span></button>
      <button id="playBtn" class="ghost">‚èØÔ∏è Pause</button>
      <span class="pill"><span id="speedLbl">Sebess√©g</span> <span id="spdLbl">1.0√ó</span></span>
      <input type="range" id="speed" min="0.5" max="5" step="0.1" value="1" style="flex:1">
    </div>
    <div class="small" id="meta"></div>
    <div style="margin-top:8px" class="muted" id="desc"></div>
    <div class="small" id="tags" style="margin:6px 0 8px 0"></div>
    <canvas id="eeg"></canvas>
    <div class="grid two" style="margin-top:10px">
      <div class="card">
        <div class="section-title" id="explainHdr">R√©szletes magyar√°zat</div>
        <div id="explain" class="muted"></div>
      </div>
      <div class="card">
        <div class="section-title" id="tipsHdr">Tippek</div>
        <ul id="tips" class="muted" style="padding-left:18px"></ul>
      </div>
    </div>
  </div>

  <!-- Identify -->
  <div class="card hidden" id="identify">
    <div class="controls" style="margin-top:10px">
      <select id="difficulty"></select>
      <button id="newIdentify" class="primary">√öj feladat ‚Üí</button>
      <button id="freezeIdentify" class="ghost">üßä Freeze</button>
      <button id="hintBtn" class="ghost">üí° Tipp</button>
    </div>
    <div class="small" id="idfMeta" style="margin-top:6px"></div>
    <canvas id="eeg2"></canvas>
    <div class="controls" style="margin-top:8px">
      <input id="guess" type="text" placeholder="">
      <button id="check">Ellen≈ërz√©s</button>
    </div>
    <div id="fb" class="kudos hidden" style="margin-top:8px"></div>
  </div>

  <!-- Quiz -->
  <div class="card hidden" id="quiz">
    <div class="controls" style="margin-top:10px">
      <select id="caseSelQ"></select>
      <button id="resetQuiz" class="ghost">üîÑ Reset</button>
      <button id="freezeQuiz" class="ghost">üßä Freeze</button>
      <button id="snapshotQuiz" class="ghost">üì∏ Next snapshot</button>
      <button id="showSolution" class="primary">Megold√°s + XP</button>
    </div>
    <div class="small" id="task" style="margin-top:4px"></div>
    <canvas id="eeg3"></canvas>
    <div class="card" style="margin-top:10px">
      <div class="section-title" id="scoreHdr">Pontsz√°m</div>
      <div class="row" style="justify-content:space-between">
        <div id="hitLbl"><span id="hitsLblTxt">Tal√°latok</span>: <span id="hits" class="score">0</span> / <span id="total">0</span></div>
        <div><span id="totalLbl">√ñsszesen</span>: <span id="pct" class="score">0%</span></div>
      </div>
      <div class="progress" style="margin-top:8px"><div id="bar"></div></div>
      <div class="small" style="margin-top:6px"><span id="bestLbl">Legjobb</span>: <span id="best">0</span>%</div>
      <div class="small" id="noEvents" style="margin-top:6px; display:none"></div>
    </div>
  </div>

  <!-- Lessons -->
  <div class="card hidden" id="lessons">
    <div class="controls" style="margin-top:10px">
      <select id="lessonLevel"></select>
      <select id="lessonSel"></select>
      <button id="startLesson" class="primary">Start</button>
    </div>
    <div id="lessonBody" class="grid two"></div>
    <div id="lessonQuiz" class="card hidden" style="margin-top:10px">
      <div class="section-title" id="miniQuizHdr">Mini-quiz</div>
      <div class="small" id="lqInstr" style="margin-bottom:6px"></div>
      <div id="lqQ" class="muted" style="margin-bottom:8px"></div>
      <div class="controls" id="lqChoices" style="flex-direction:column;align-items:flex-start"></div>
      <div class="controls"><button id="lqSubmit" class="primary">Submit</button></div>
      <div id="lqFb" class="kudos hidden" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="card">
    <div class="section-title" id="medalHdr">Med√°lok</div>
    <ul id="medals" class="muted" style="padding-left:18px; margin:0"></ul>
  </div>

  <div class="footer" id="footerTxt">Canvas Dev build. K√∂v.: EDF/CSV import, JSON export, t√∂bb hard case, csatorna√©rz√©keny pontoz√°s.</div>
</div>

<div id="errorBanner"></div>

<script>
/* ==== Safe storage (GitHub Pages/iframes) ==== */
const SafeStore = (()=> {
  try { const t='__eeg_test__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }
  catch(e){ const mem={}; return {getItem:k=>mem[k]??null, setItem:(k,v)=>{mem[k]=String(v)}, removeItem:k=>{delete mem[k]}}; }
})();
const getLS=(k,def=null)=>{ try{ const v=SafeStore.getItem(k); return v===null?def:v; }catch(e){ return def; } };
const setLS=(k,v)=>{ try{ SafeStore.setItem(k,v); }catch(e){} };

/* ==== i18n (HU/EN) ==== */
const I18N = {
  HU: {
    explore:"Explore", identify:"Identify", quiz:"Quiz", lessons:"Lessons",
    solution:"Megold√°s", on:"be", off:"ki", pause:"Pause", play:"Play",
    speed:"Sebess√©g", details:"R√©szletes magyar√°zat", tips:"Tippek",
    beginner:"Kezd≈ë", intermediate:"K√∂z√©phalad√≥", hard:"Neh√©z", expert:"Expert", mixed:"Vegyes", all:"Mind",
    newTask:"√öj feladat ‚Üí", freeze:"üßä Fagyaszt√°s", hint:"üí° Tipp",
    guessPH:"Mi ez a minta? pl. LPDs, generalized spike-wave, triphasic, SIRPIDs‚Ä¶",
    check:"Ellen≈ërz√©s", score:"Pontsz√°m", hits:"Tal√°latok", total:"√ñsszesen",
    best:"Legjobb", medals:"Med√°lok", level:"Szint", xp:"XP",
    nextSnap:"üì∏ K√∂vetkez≈ë snapshot", reset:"üîÑ Reset", start:"Start",
    footer:"Canvas Dev build. K√∂v.: EDF/CSV import, JSON export, t√∂bb hard case, csatorna√©rz√©keny pontoz√°s.", 
    correct:"+20 XP ‚Äì Helyes!", wrong:"+2 XP ‚Äì Nem ez. Megold√°s: ",
    hintText:"Els≈ë bet≈±k: ", caseMeta:(m,d,l)=>`Mont√°zs: ${m}  ‚Ä¢  Neh√©zs√©g: ${d}  ‚Ä¢  C√≠m: ${l}`,
    idfMeta:(d,m)=>`Neh√©zs√©g: ${d}  ‚Ä¢  Mont√°zs: ${m}`,
    task:(what)=>`Feladat: jel√∂ld be a(z) ${what} el≈ëfordul√°sait! (Freeze + Snapshot aj√°nlott)` ,
    noEvents:"Ehhez a kiv√°lasztott esett√≠pushoz nincs c√≠mk√©zett esem√©ny a kv√≠zben. V√°lassz m√°sikat vagy k√©sz√≠ts snapshotot.",
    levelLbl:"Szint", xpLbl:"XP",
    miniQuiz:"Mini-quiz", selectAll:"Jel√∂ld meg az √∂sszes helyes √°ll√≠t√°st.", submit:"Bek√ºld√©s",
    gained:"Szerzett XP: ", bestPossible:"Max: ", lessonsBeginner:"Kezd≈ë", lessonsIntermediate:"K√∂z√©phalad√≥", lessonsExpert:"Expert"
  },
  EN: {
    explore:"Explore", identify:"Identify", quiz:"Quiz", lessons:"Lessons",
    solution:"Solution", on:"on", off:"off", pause:"Pause", play:"Play",
    speed:"Speed", details:"Detailed explanation", tips:"Tips",
    beginner:"Beginner", intermediate:"Intermediate", hard:"Hard", expert:"Expert", mixed:"Mixed", all:"All",
    newTask:"New task ‚Üí", freeze:"üßä Freeze", hint:"üí° Hint",
    guessPH:"What is this pattern? e.g., LPDs, generalized spike-wave, triphasic, SIRPIDs‚Ä¶",
    check:"Check", score:"Score", hits:"Hits", total:"Total",
    best:"Best", medals:"Medals", level:"Level", xp:"XP",
    nextSnap:"üì∏ Next snapshot", reset:"üîÑ Reset", start:"Start",
    footer:"Canvas Dev build. Next: EDF/CSV import, JSON export, more hard cases, channel-aware scoring.", 
    correct:"+20 XP ‚Äì Correct!", wrong:"+2 XP ‚Äì Not this. Solution: ",
    hintText:"Initials: ", caseMeta:(m,d,l)=>`Montage: ${m}  ‚Ä¢  Difficulty: ${d}  ‚Ä¢  Title: ${l}`,
    idfMeta:(d,m)=>`Difficulty: ${d}  ‚Ä¢  Montage: ${m}`,
    task:(what)=>`Task: click all ${what} occurrences! (Freeze + Snapshot recommended)`,
    noEvents:"This case has no labeled events for the quiz. Pick another or take a snapshot.",
    levelLbl:"Level", xpLbl:"XP",
    miniQuiz:"Mini-quiz", selectAll:"Select all correct statements.", submit:"Submit",
    gained:"XP gained: ", bestPossible:"Max: ", lessonsBeginner:"Beginner", lessonsIntermediate:"Intermediate", lessonsExpert:"Expert"
  }
};
let LANG = getLS("eeg_lang","HU") || "HU";
function tK(k){ return I18N[LANG][k] || k; }
function setLang(L){ LANG=L; setLS("eeg_lang",L); syncTexts(); refreshCaseOptions(); refreshCaseOptionsQ(); buildDifficulty(); buildLessonLevels(); refreshLessons(); }

/* ==== Simple XP (no profiles) ==== */
let XP = parseInt(getLS('eeg_xp','0')||'0',10);
let BEST = parseInt(getLS('eeg_best','0')||'0',10);
let STREAK = parseInt(getLS('eeg_streak','0')||'0',10);
function levelFromXP(x){ return Math.floor(x/100)+1; }
function saveProgress(){ setLS('eeg_xp', String(XP)); setLS('eeg_best', String(BEST)); setLS('eeg_streak', String(STREAK)); }
function awardXP(n){ XP+=n; saveProgress(); refreshMeta(); }
function medalsList(){ const m=[]; if(STREAK>=5)m.push('Komb√°jn ‚Äì 5 helyes egym√°s ut√°n'); if(BEST>=90)m.push('Sasszem ‚Äì 90%+'); if(XP>=300)m.push('Maraton ‚Äì 300 XP'); return m; }
function refreshMeta(){
  byId('xp').textContent=String(XP);
  byId('lvl').textContent=String(levelFromXP(XP));
  byId('lvlLbl').textContent=tK('levelLbl');
  byId('xpLbl').textContent=tK('xpLbl');
  const medals=byId('medals'); medals.innerHTML='';
  const m=medalsList();
  if(!m.length){ medals.innerHTML = '<li>'+(LANG==='HU'?'M√©g nincs ‚Äì gy≈±jts kih√≠v√°sokat!':'No medals yet ‚Äî keep going!')+'</li>'; }
  else m.forEach(x=>{ const li=document.createElement('li'); li.textContent=x; medals.appendChild(li); });
  byId('best').textContent=String(BEST);
}

/* ==== Data generation ==== */
function genChannel(N, noise=0.6, spikes=[], mag=4, baseHz=0){
  const arr=[];
  for(let i=0;i<N;i++){
    const base=(baseHz?Math.sin(i/(S/(baseHz*2*Math.PI)))*1.0:0) + Math.sin(i/25)*0.6;
    const drift=Math.sin(i/220)*0.4;
    let v = base + drift + (Math.random()-0.5)*noise;
    if(spikes.includes(i)) v+=mag;
    if(spikes.some(s=>Math.abs(i-s)<=2)){
      const near=spikes.find(s=>Math.abs(i-s)<=2);
      v += mag*(1-Math.abs(i-near)/2);
    }
    arr.push(v);
  }
  return arr;
}
const S=1000; // ~10 s ablak
function makeCase(id,meta){ return Object.assign({id, sampleRate:S}, meta); }
function materialize(c){
  c.channels = c.channels.map((name,idx)=>{
    const spikes = (typeof c.spikesFn==="function")?c.spikesFn(idx):[];
    return {name, data:genChannel(S, c.noise||0.45, spikes, c.magFn?c.magFn(idx):4, c.baseHz||0), spikes};
  });
  return c;
}

/* ==== Cases (b≈ëv√≠tett magyar√°zatok) ==== */
const CASES = [
  makeCase('normal_alpha',{ titleHU:'Norm√°l √©ber ‚Äì occipitalis alfa', titleEN:'Normal awake ‚Äì occipital alpha', montage:'10‚Äì20',
    descHU:'8‚Äì10 Hz occipitalis alfa, reakt√≠v.', descEN:'8‚Äì10 Hz occipital alpha, reactive.',
    explainHU:'8‚Äì10 Hz-es, occipitalis t√∫ls√∫ly√∫ ritmus √©ber, csukott szem≈± √°llapotban. Jellemz≈ë a szimmetria (¬±20%) √©s a szemnyit√°sra t√∂rt√©n≈ë g√°tl√°s (blokkol√≥d√°s). Amplit√∫d√≥ t√∂bbnyire 20‚Äì100 ¬µV. Aszimmetria, tart√≥s reaktivit√°shi√°ny vagy oldal-dominancia m√∂g√∂tt szem√©szeti, occipitalis vagy diff√∫z k√≥rfolyamat is √°llhat.',
    explainEN:'Occipital-predominant 8‚Äì10 Hz rhythm in awake, eyes-closed state. Key features: symmetry (¬±20%), blocking with eye opening, typical amplitude 20‚Äì100 ¬µV. Persistent asymmetry or loss of reactivity may suggest occipital pathology or diffuse encephalopathy.',
    tipsHU:['Szimmetria ellen≈ërz√©se','Szemnyit√°sra g√°tl√≥dik','Nincs hegyes spike'], tipsEN:['Check symmetry','Blocked by eye opening','No sharp spikes'],
    diff:'beginner', label:'normal alpha', channels:['O1-O2','P3-O1','P4-O2','C3-P3','C4-P4'], spikesFn:()=>[], magFn:()=>0, baseHz:9, includeInQuiz:false, quizTargetHU:'alfa ritmus', quizTargetEN:'alpha rhythm', tags:['benign','awake'] }),

  makeCase('sleep_spindles',{ titleHU:'N2 ‚Äì alv√°si ors√≥k', titleEN:'N2 ‚Äì sleep spindles', montage:'10‚Äì20',
    descHU:'12‚Äì14 Hz ors√≥k centr√°lisan.', descEN:'12‚Äì14 Hz central spindles.',
    explainHU:'R√∂vid (0.5‚Äì2 s) 12‚Äì14 Hz-es ‚Äûvonatszer≈±‚Äù aktivit√°s, centr√°lisan maxim√°lis. Gyakran K-komplex el≈ëzi meg/k√≠s√©ri. Nem epileptiform, fiziol√≥gi√°s N2 marker. Id≈ësekn√©l/morbidit√°sokban frekvencia/amplit√∫d√≥ v√°ltozhat.',
    explainEN:'Brief (0.5‚Äì2 s) 12‚Äì14 Hz trains with central maximum. Often preceded/accompanied by a K-complex. Physiologic N2 marker; not epileptiform. Frequency/amplitude may vary with age and comorbidity.',
    tipsHU:['Centr√°lis maximum','Vonatszer≈± megjelen√©s','Nincs lass√∫ hull√°m ut√°na, mint SW-ben'], tipsEN:['Central maximum','Train-like','No paired slow wave as in SW'],
    diff:'beginner', label:'sleep spindles', channels:['C3-P3','C4-P4','Fz-Cz'], spikesFn:()=>[], magFn:()=>0, baseHz:13, includeInQuiz:false, quizTargetHU:'ors√≥', quizTargetEN:'spindle', tags:['sleep','benign'] }),

  makeCase('eyeblink',{ titleHU:'Artefaktum ‚Äì pislog√°s', titleEN:'Artifact ‚Äì eye blink', montage:'Front√°lis',
    descHU:'Nagy front√°lis lass√∫ hull√°m.', descEN:'Large frontal slow deflection.',
    explainHU:'Sima, sz√©les b√°zis√∫ front√°lis deflexi√≥, gyakran k√©toldali, polarit√°sv√°lt√°ssal. Meredeks√©ge kisebb, mint az epileptiform t√ºsk√©k√©, √©s nem k√∂veti konzisztens lass√∫ hull√°m. Gyakran kapcsol√≥dik szemmozg√°shoz/EMG-hez.',
    explainEN:'Smooth, broad-based frontal deflection, often bilateral with polarity change. Less steep than epileptiform spikes and not followed by a consistent slow wave. Frequently associated with eye movement/EMG.',
    tipsHU:['Front√°lis t√∫ls√∫ly','Sima lefut√°s','Nem k√∂veti lass√∫ hull√°m'], tipsEN:['Frontal predominance','Smooth','No spike-slow pairing'],
    diff:'beginner', label:'eye blink', channels:['Fp1-F3','Fp2-F4','Fz-Cz'], spikesFn:(i)=> (i===0?[150,520]:[]), magFn:(i)=> (i===0?6:2), noise:0.3, includeInQuiz:false, quizTargetHU:'pislog√°s', quizTargetEN:'blink', tags:['artifact'] }),

  makeCase('gsw3',{ titleHU:'Generaliz√°lt t√ºske-hull√°m (~3 Hz)', titleEN:'Generalized spike‚Äìwave (~3 Hz)', montage:'10‚Äì20 ref',
    descHU:'Szinkron 3 Hz SW.', descEN:'Synchronous 3 Hz SW.',
    explainHU:'Klasszikus absence mint√°zat: hegyes t√ºske + ut√°na lass√∫ hull√°m, 2.5‚Äì3.5 Hz √ºtemben, t√∂bb csatorn√°n szinkron. A ciklusok id≈ëz√≠t√©se konzisztens. Artefaktumt√≥l a topogr√°fiai/tempor√°lis k√∂vetkezetess√©g k√ºl√∂n√≠ti el.',
    explainEN:'Classic absence pattern: sharp spike followed by a slow wave at ~2.5‚Äì3.5 Hz, synchronous across channels. Temporal/topographic consistency separates it from artifacts.',
    tipsHU:['Szinkron t√∂bb csatorn√°n','Spike ut√°n lass√∫ hull√°m','Artefaktumt√≥l k√∂vetkezetess√©g k√ºl√∂n√≠ti el'], tipsEN:['Synchronous across channels','Slow wave follows spike','Consistency helps separate artifacts'],
    diff:'beginner', label:'generalized spike-wave', channels:['Fp1-F3','F3-C3','C3-P3','P3-O1','Fp2-F4','F4-C4','C4-P4','P4-O2'], spikesFn:()=>[160,190,220,250,280,310,340], magFn:(i)=>5-(i%3), includeInQuiz:true, quizTargetHU:'t√ºske-hull√°m', quizTargetEN:'spike‚Äìwave', tags:['generalized','ictal/interictal'] }),

  makeCase('lt_spikes',{ titleHU:'Bal tempor√°lis t√ºsk√©k', titleEN:'Left temporal spikes', montage:'Bitempor√°lis',
    descHU:'Fok√°lis T3/T5 max.', descEN:'Focal T3/T5 max.',
    explainHU:'Keskeny, meredek cs√∫cs√∫ t√ºsk√©k bal tempor√°lisan, aszinkron t√∂bb csatorn√°n, gyakran ut√≥lag lass√∫ hull√°m k√≠s√©ret√©ben. A later√°lis maximum √©s a konzisztens morfol√≥gia f√≥kuszt jelez.',
    explainEN:'Narrow, steep spikes over the left temporal region, asynchronous across channels, often followed by a slow wave. Lateralized maximum and consistent morphology indicate a focal generator.',
    tipsHU:['Ipsilater√°lis maximum','Meredek fel/le','Gyakran k√≠s√©ri lass√∫ hull√°m'], tipsEN:['Ipsilateral max','Steep up/down','Often followed by slow'],
    diff:'intermediate', label:'left temporal spikes', channels:['F7-T3','T3-T5','T5-O1','F8-T4','T4-T6','T6-O2'], spikesFn:(i)=> (i<3?[200,410,640]:[205,415,645]), magFn:(i)=> (i<3?5:2), includeInQuiz:true, quizTargetHU:'fok√°lis t√ºsk√©k', quizTargetEN:'focal spikes', tags:['temporal','focal'] }),

  makeCase('rt_spikes',{ titleHU:'Jobb tempor√°lis t√ºsk√©k', titleEN:'Right temporal spikes', montage:'Bitempor√°lis',
    descHU:'Fok√°lis T4/T6 max.', descEN:'Focal T4/T6 max.',
    explainHU:'Id≈ëben sz√≥rtan jelentkez≈ë t√ºsk√©k jobb dominanci√°val. A meredek fel- √©s lefut√°s, valamint a visszat√©r≈ë topogr√°fia epileptiformit√°s mellett sz√≥l.',
    explainEN:'Temporally scattered spikes with right-sided predominance. Steep rise/fall and recurring topography support epileptiform nature.',
    tipsHU:['Ipsilater√°lis max','Keskeny cs√∫cs','Topogr√°fia seg√≠t'], tipsEN:['Ipsilateral max','Narrow peak','Use topography'],
    diff:'intermediate', label:'right temporal spikes', channels:['F7-T3','T3-T5','T5-O1','F8-T4','T4-T6','T6-O2'], spikesFn:(i)=> (i>=3?[220,430,660]:[225,435,665]), magFn:(i)=> (i>=3?5:2), includeInQuiz:true, quizTargetHU:'fok√°lis t√ºsk√©k', quizTargetEN:'focal spikes', tags:['temporal','focal'] }),

  makeCase('lpds',{ titleHU:'LPDs ‚Äì jobb', titleEN:'LPDs ‚Äì right', montage:'Referenci√°lis',
    descHU:'Periodikus jobb oldali kis√ºl√©sek.', descEN:'Periodic right-sided discharges.',
    explainHU:'Az ‚Äûictal‚Äìinterictal continuum‚Äù r√©sze. Later√°lis, szab√°lyos 1‚Äì2 s peri√≥dus√∫ kis√ºl√©sek, jellegzetes morfol√≥gi√°val. A klinikum (tudatszint, motoros jelek) √©s a fejl≈ëd√©si tendencia (gyakoris√°g, evol√∫ci√≥) seg√≠t a st√°tusz d√∂nt√©s√©ben.',
    explainEN:'Part of the ictal‚Äìinterictal continuum. Lateralized discharges with ~1‚Äì2 s periodicity and stereotyped morphology. Clinical correlation and temporal evolution (frequency/morphologic change) are key for NCSE decisions.',
    tipsHU:['1‚Äì2 s peri√≥dus','Later√°lis dominancia','Klinikai korrel√°tum fontos'], tipsEN:['1‚Äì2 s period','Lateralized','Clinical correlation'],
    diff:'hard', label:'lpds', channels:['F8-T4','T4-T6','T6-O2','F7-T3','T3-T5'], spikesFn:(i)=> (i<3?[150,300,450,600,750]:[]), magFn:(i)=> (i<3?4:1), includeInQuiz:true, quizTargetHU:'periodikus kis√ºl√©sek', quizTargetEN:'periodic discharges', tags:['periodic','focal'] }),

  makeCase('gpeds',{ titleHU:'GPDs ‚Äì generaliz√°lt periodikus', titleEN:'GPDs ‚Äì generalized periodic', montage:'Referenci√°lis',
    descHU:'Generaliz√°lt periodicit√°s.', descEN:'Generalized periodicity.',
    explainHU:'Sz√©lesen eloszl√≥, szab√°lyos ritmus√∫ komplexek, gyakran metabolikus/anoxi√°s h√°t√©rrel. Nem sz√ºks√©gk√©pp ict√°lis; a klinikum √©s a reaktivit√°s (stimulusra) seg√≠t. Ritk√°bban ‚Äûplusz‚Äù gyors komponens (GPD+F) ictalit√°s fel√© tol.',
    explainEN:'Diffuse, regular periodic complexes, often in metabolic/post-anoxic contexts. Not necessarily ictal; clinical context and stimulus reactivity matter. A fast component (GPD+F) may shift toward ictality.',
    tipsHU:['Sz√©lesk√∂r≈±','Periodikus','Klinikum d√∂nt'], tipsEN:['Diffuse','Periodic','Clinical context'],
    diff:'hard', label:'gpds', channels:['F3-C3','C3-P3','F4-C4','C4-P4','P3-O1','P4-O2'], spikesFn:(i)=>[200,400,600,800], magFn:(i)=>3, includeInQuiz:true, quizTargetHU:'periodikus kis√ºl√©sek', quizTargetEN:'periodic discharges', tags:['periodic','generalized'] }),

  makeCase('triphasic',{ titleHU:'Triphasic hull√°mok', titleEN:'Triphasic waves', montage:'Referenci√°lis',
    descHU:'Metabolikus encephalopathia mint√°zat.', descEN:'Metabolic encephalopathy pattern.',
    explainHU:'H√°romf√°zis√∫ (negat√≠v‚Äìpozit√≠v‚Äìnegat√≠v) komplexek front√°lis t√∫ls√∫llyal √©s anterior‚Äìposterior id≈ëbeli k√©s√©ssel. Nem spike‚Äìslow p√°rok, ink√°bb encephalopathi√°ra utalnak (pl. hepaticus).',
    explainEN:'Three-phase (negative‚Äìpositive‚Äìnegative) complexes with frontal predominance and anterior‚Äìposterior time lag. Non-epileptiform; typical for metabolic encephalopathy (e.g., hepatic).',
    tipsHU:['Front√°lis t√∫ls√∫ly','H√°rom f√°zis','Nem spike‚Äìslow'], tipsEN:['Frontal pred.','Three phases','Not spike‚Äìslow'],
    diff:'hard', label:'triphasic waves', channels:['Fp1-F3','F3-C3','Fz-Cz','Fp2-F4','F4-C4'], spikesFn:()=>[140,300,470,640], magFn:()=>2, includeInQuiz:true, quizTargetHU:'triphasicus komplexek', quizTargetEN:'triphasic complexes', tags:['encephalopathy'] }),

  makeCase('burst_supp',{ titleHU:'Burst-suppression', titleEN:'Burst-suppression', montage:'Referenci√°lis',
    descHU:'R√∂vid burst + csend.', descEN:'Short bursts with suppression.',
    explainHU:'R√∂vid nagyamplit√∫d√≥j√∫ ‚Äûburst‚Äù-√∂k hossz√∫, k√∂zel izoelektromos szakaszokkal. Anoxia/aneszt√©zia eset√©n. A suppressio ar√°nya √©s hossza prognosztikus; reaktivit√°s hi√°nya kedvez≈ëtlen.',
    explainEN:'High-amplitude bursts alternating with long near-isoelectric periods. Seen post-anoxia or under anesthesia. Suppression ratio/length has prognostic value; absent reactivity is unfavorable.',
    tipsHU:['Nagyon alacsony alap','Burst szigetek','Hossz√∫ suppressio s√∫lyosabb'], tipsEN:['Very low baseline','Burst islands','Long suppression worse'],
    diff:'hard', label:'burst-suppression', channels:['C3-P3','C4-P4','P3-O1','P4-O2'], spikesFn:(i)=>[120,130,131,400,410,411,700,710,711], magFn:()=>5, noise:0.2, includeInQuiz:true, quizTargetHU:'bursts', quizTargetEN:'bursts', tags:['coma','anesthesia'] })
].map(materialize);

/* ==== Synonyms (kompatibilis normaliz√°l√°ssal) ==== */
const SYN = {
  "generalized spike-wave":["gsw","3hz","absence","generalizalt tuske hullam","generalized spike wave"],
  "left temporal spikes":["lt","bal temporalis","bal temporalis tuske","t3","t5","temp spikes"],
  "right temporal spikes":["rt","jobb temporalis","jobb temporalis tuske","t4","t6","temp spikes"],
  "triphasic waves":["triphasic","triphasicus","hepatic","metabolic encephalopathy"],
  "lpds":["lpd","lpds","pleds","pled","lateralized periodic discharges"],
  "gpds":["gpd","gpeds","generalized periodic discharges"],
  "burst-suppression":["burst","suppression","bs"],
  "normal alpha":["normal","normal eeg","alfa","alpha","normal alpha","normalis alfa"],
  "sleep spindles":["spindle","orsok","orso","spindles"],
  "eye blink":["blink","eyeblink","pislogas","szemmozgas"]
};
// UNICODE-safe normalizer
function normalize(s){
  return s.toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9\s-]/g," ")
    .replace(/\s+/g," ")
    .trim();
}
function isSynonym(guess, canonical){
  const g=normalize(guess), c=normalize(canonical);
  if(g===c) return true;
  const list = SYN[canonical]||[];
  if(list.some(x=>normalize(x)===g)) return true;
  const toks = g.split(" "); if(toks.some(t=>c.includes(t)&&t.length>=4)) return true;
  return false;
}

/* ==== State & helpers ==== */
let mode='explore', showAns=true, playing=true, speed=1.0; let tExplore=0; let diffFilter='beginner';
let current=CASES[0], idCurrent=CASES[0], idFreeze=false, idOff=0; 
let qCurrent=CASES.find(c=>c.includeInQuiz)||CASES[0], qFreeze=false, qShowAnswer=false, qOff=0, marks=[];
function rotatedIndex(i, off, N){ return ((i-off)%N + N) % N; }
function byId(x){ return document.getElementById(x); }

/* ==== UI text sync ==== */
function syncTexts(){
  byId('tabExplore').textContent = tK('explore');
  byId('tabIdentify').textContent = tK('identify');
  byId('tabQuiz').textContent = tK('quiz');
  byId('tabLessons').textContent = tK('lessons');
  byId('solutionLbl').textContent = tK('solution');
  byId('ansLbl').textContent = showAns ? tK('on') : tK('off');
  byId('speedLbl').textContent = tK('speed');
  byId('spdLbl').textContent = speed.toFixed(1)+'√ó';
  byId('explainHdr').textContent = tK('details');
  byId('tipsHdr').textContent = tK('tips');
  byId('newIdentify').textContent = tK('newTask');
  byId('freezeIdentify').textContent = tK('freeze');
  byId('hintBtn').textContent = tK('hint');
  byId('guess').placeholder = tK('guessPH');
  byId('check').textContent = tK('check');
  byId('resetQuiz').textContent = tK('reset');
  byId('freezeQuiz').textContent = tK('freeze');
  byId('snapshotQuiz').textContent = tK('nextSnap');
  byId('showSolution').textContent = tK('solution')+' + XP';
  byId('scoreHdr').textContent = tK('score');
  byId('hitsLblTxt').textContent = tK('hits');
  byId('totalLbl').textContent = tK('total');
  byId('bestLbl').textContent = tK('best');
  byId('medalHdr').textContent = tK('medals');
  byId('footerTxt').textContent = tK('footer');
  byId('langBtn').textContent = LANG + ' ‚ñæ';
  byId('miniQuizHdr').textContent = tK('miniQuiz');
  byId('lqInstr').textContent = tK('selectAll');
  byId('lqSubmit').textContent = tK('submit');
  syncMeta(); syncTask(); refreshMeta();
}
function syncMeta(){
  byId('meta').textContent = tK('caseMeta')(current.montage, mapDiff(current.diff), (LANG==='HU'?current.titleHU:current.titleEN));
  byId('desc').textContent = (LANG==='HU'?current.descHU:current.descEN);
  const tagDiv=byId('tags'); tagDiv.innerHTML = (current.tags||[]).map(x=>`<span class="chip">${x}</span>`).join(' ');
  byId('explain').textContent = (LANG==='HU'?current.explainHU:current.explainEN);
  const tips = (LANG==='HU'?current.tipsHU:current.tipsEN); const ul = byId('tips'); ul.innerHTML=''; tips.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
}
function mapDiff(d){
  const m = { beginner: tK('beginner'), intermediate: tK('intermediate'), hard:tK('hard'), expert:tK('expert') };
  return m[d] || d;
}
function syncTask(){ const txt = LANG==='HU' ? (qCurrent.quizTargetHU||'esem√©nyek') : (qCurrent.quizTargetEN||'events'); byId('task').textContent = tK('task')(txt); const has = quizTotal()>0; byId('noEvents').style.display = has?'none':'block'; byId('noEvents').textContent = tK('noEvents'); }

/* ==== Tabs ==== */
function setTab(tab){ mode=tab; byId('tabExplore').className = tab==='explore'?'primary':'ghost'; byId('tabIdentify').className = tab==='identify'?'primary':'ghost'; byId('tabQuiz').className = tab==='quiz'?'primary':'ghost'; byId('tabLessons').className = tab==='lessons'?'primary':'ghost'; byId('explore').classList.toggle('hidden', tab!=='explore'); byId('identify').classList.toggle('hidden', tab!=='identify'); byId('quiz').classList.toggle('hidden', tab!=='quiz'); byId('lessons').classList.toggle('hidden', tab!=='lessons'); }
byId('tabExplore').onclick=()=>setTab('explore'); byId('tabIdentify').onclick=()=>setTab('identify'); byId('tabQuiz').onclick=()=>setTab('quiz'); byId('tabLessons').onclick=()=>setTab('lessons');

/* ==== Explore ==== */
const caseSel = byId('caseSel');
function refreshCaseOptions(){ caseSel.innerHTML=''; CASES.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=(LANG==='HU'?c.titleHU:c.titleEN); caseSel.appendChild(o); }); caseSel.value=current.id; }
caseSel.onchange=()=>{ current = CASES.find(c=>c.id===caseSel.value); syncMeta(); };
byId('toggleAns').onclick=()=>{ showAns=!showAns; byId('ansLbl').textContent=showAns?tK('on'):tK('off'); };
byId('playBtn').onclick=()=>{ playing=!playing; byId('playBtn').textContent= playing?'‚èØÔ∏è '+tK('pause'):'‚ñ∂Ô∏è '+tK('play'); };
byId('speed').oninput=(e)=>{ speed=parseFloat(e.target.value); byId('spdLbl').textContent=speed.toFixed(1)+'√ó'; };

/* ==== Identify ==== */
const difficulty = byId('difficulty');
function buildDifficulty(){ const opts=[["beginner",tK('beginner')],["intermediate",tK('intermediate')],["hard",tK('hard')],["expert",tK('expert')],["all",tK('all')]]; difficulty.innerHTML=''; opts.forEach(([v,txt])=>{ const o=document.createElement('option'); o.value=v; o.textContent=txt; difficulty.appendChild(o); }); difficulty.value=diffFilter; }
const idfMeta = byId('idfMeta'); const guess = byId('guess'); const fb = byId('fb');
difficulty.onchange=()=>{ diffFilter = difficulty.value; };
byId('newIdentify').onclick=()=>idRandomCase(); byId('freezeIdentify').onclick=()=>{ idFreeze=!idFreeze; if(!idFreeze) idOff=0; };
byId('hintBtn').onclick=()=>{ const initials = idCurrent.label.split(' ').map(w=>w[0].toUpperCase()).join(''); fb.classList.remove('hidden','no'); fb.classList.add('ok'); fb.textContent = tK('hintText') + initials; };
byId('check').onclick=handleIdentify;
function filteredCases(){
  if(diffFilter==='all') return CASES;
  if(diffFilter==='expert') return CASES.filter(c=>c.diff==='expert'||c.diff==='hard'); // expert ~ hard fallback
  return CASES.filter(c=>c.diff===diffFilter);
}
function idRandomCase(){ const arr=filteredCases(); idCurrent = arr[Math.floor(Math.random()*arr.length)]; idfMeta.textContent = tK('idfMeta')(mapDiff(idCurrent.diff), idCurrent.montage); guess.value=''; fb.className='kudos hidden'; fb.textContent=''; }
idRandomCase();
function handleIdentify(){ const g = guess.value.trim(); if(!g) return; const ok = isSynonym(g, idCurrent.label); fb.classList.remove('hidden'); fb.classList.add(ok?'ok':'no'); fb.textContent = ok ? tK('correct') : (tK('wrong') + idCurrent.label); awardXP(ok?20:2); if(ok){ STREAK++; setTimeout(()=>{ idRandomCase(); refreshMeta(); }, 900); } else { STREAK=0; refreshMeta(); } saveProgress(); }

/* ==== Quiz + snapshot ==== */
const caseSelQ = byId('caseSelQ');
function refreshCaseOptionsQ(){ caseSelQ.innerHTML=''; CASES.filter(c=>c.includeInQuiz).forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=(LANG==='HU'?c.titleHU:c.titleEN); caseSelQ.appendChild(o); }); caseSelQ.value=qCurrent.id; }
caseSelQ.onchange=()=>{ qCurrent = CASES.find(c=>c.id===caseSelQ.value); marks=[]; qShowAnswer=false; qOff=0; syncQuizMeta(); syncTask(); };
byId('resetQuiz').onclick=()=>{ marks=[]; qShowAnswer=false; qOff=0; syncQuizMeta(); };
byId('freezeQuiz').onclick=()=>{ qFreeze=!qFreeze; if(!qFreeze){ qOff=0; } };
byId('snapshotQuiz').onclick=()=>{ qFreeze=true; qOff = Math.floor(Math.random()* (qCurrent.sampleRate-1) ); syncQuizMeta(); };
byId('showSolution').onclick=()=>{ qShowAnswer=true; const pct=quizPct(); awardXP( pct>=80 ? 40 : 15 ); BEST = Math.max(BEST, pct); saveProgress(); refreshMeta(); };
byId('eeg3').addEventListener('click',(e)=>{ if(mode!=='quiz') return; const r=e.target.getBoundingClientRect(); const x=(e.clientX-r.left)*devicePixelRatio; const y=(e.clientY-r.top)*devicePixelRatio; marks.push({x,y}); syncQuizMeta(); });
function quizTotal(){ return qCurrent.channels.reduce((a,ch)=>a+(ch.spikes?.length||0),0); }
function quizHits(off=0){ const dx=60*devicePixelRatio, xScale=(byId('eeg3').width / qCurrent.sampleRate); let correct=0; qCurrent.channels.forEach(ch=> ch.spikes.forEach(sx=>{ const pos = rotatedIndex(sx, off, qCurrent.sampleRate); const sxpx = pos*xScale; if(marks.some(m=>Math.abs(m.x-sxpx)<dx)) correct++; })); return correct; }
function quizPct(){ const t=quizTotal(); const h=quizHits(qOff); return t?Math.round(h/t*100):0; }
function syncQuizMeta(){ byId('total').textContent=String(quizTotal()); byId('hits').textContent=String(quizHits(qOff)); const p=quizPct(); byId('pct').textContent=p+'%'; byId('bar').style.width=p+'%'; }

/* ==== Lessons (t√∂bb minta) ==== */
const LESSONS = (()=> {
  function mk(level,arr){ return arr.map(([id,hu,en,steps,q])=>({id, level, titleHU:hu, titleEN:en, steps:steps.map(([huS,enS])=>({htmlHU:huS, htmlEN:enS})), quiz:{ qHU:q.qHU, qEN:q.qEN, choices:q.choices.map(([huC,enC,ok,xp])=>({hu:huC,en:enC,ok,xp})) } })); }
  const B = [
    ['sleep_basics','Alv√°s alapok','Sleep basics',[
      ['N1: vertex √©lesek megjelenhetnek.','N1: vertex sharps may appear.'],
      ['N2: ors√≥k + K-komplex.','N2: spindles + K-complex.']
    ], {qHU:'Melyik N2-re jellemz≈ë?', qEN:'Characteristic of N2?', choices:[['K-komplex','K-complex',true,5],['Mu-ritmus','Mu rhythm',false,0],['Ors√≥k','Spindles',true,5]]}],
    ['artifact_vs_spike','Artefaktum vs. spike','Artifact vs spike',[
      ['Pislog√°s: front√°lis lass√∫, nem hegyes.','Blink: frontal slow, not sharp.'],
      ['Spike: meredek fel/le, lass√∫ hull√°m k√∂veti.','Spike: steep up/down, followed by slow wave.']
    ], {qHU:'Mi EMG?', qEN:'Which is EMG?', choices:[['Sz√©less√°v√∫ zaj','Broadband noise',true,6],['3 Hz SW p√°rok','3 Hz SW pairs',false,0]]}],
    ['alpha_basics','Norm√°l alfa','Normal alpha',[
      ['8‚Äì10 Hz occipitalis, reakt√≠v.','8‚Äì10 Hz occipital, reactive.']
    ], {qHU:'Mi norm√°lis?', qEN:'Which is normal?', choices:[['Reakt√≠v alfa','Reactive alpha',true,5],['Generaliz√°lt SW','Generalized SW',false,0],['Szimmetria','Symmetry',true,5]]}],
    ['gsw_intro','3 Hz SW bevezet≈ë','Intro to 3 Hz SW',[
      ['Spike + lass√∫ hull√°m, 2.5‚Äì3.5 Hz.','Spike + slow wave at 2.5‚Äì3.5 Hz.'],
      ['Szimmetrikus, generaliz√°lt.','Symmetric and generalized.']
    ], {qHU:'Mi NEM jellemz≈ë?', qEN:'NOT typical?', choices:[['Front√°lis lok√°lis maximum','Focal frontal maximum',true,5],['Lass√∫ hull√°m a spike ut√°n','Slow wave after spike',false,0]]}],
    ['sleep_spindles_more','Ors√≥k r√©szletesen','Spindles in detail',[
      ['Centr√°lis maximum, 12‚Äì14 Hz.','Central max, 12‚Äì14 Hz.'],
      ['K-komplex t√°rsulhat.','Often with K-complex.']
    ], {qHU:'Ors√≥k frekvenci√°ja?', qEN:'Spindle frequency?', choices:[['12‚Äì14 Hz','12‚Äì14 Hz',true,5],['3 Hz','3 Hz',false,0]]}]
  ];
  const I = [
    ['temporal_spikes','Tempor√°lis t√ºsk√©k','Temporal spikes',[
      ['T3/T5 max bal f√≥kuszban.','T3/T5 max in left focus.']
    ], {qHU:'Mi utal epileptiformit√°sra?', qEN:'Suggests epileptiform?', choices:[['Meredek cs√∫cs','Steep peak',true,6],['Sima domborulat','Smooth hump',false,0],['Lass√∫ hull√°m k√≠s√©ri','Associated slow',true,6]]}],
    ['firda_oirda','FIRDA vs OIRDA','FIRDA vs OIRDA',[
      ['FIRDA: front√°lis; OIRDA: occipitalis.','FIRDA: frontal; OIRDA: occipital.']
    ], {qHU:'P√°ros√≠tsd!', qEN:'Match!', choices:[['FIRDA‚Üífront√°lis','FIRDA‚Üífrontal',true,6],['OIRDA‚Üíoccipitalis','OIRDA‚Üíoccipital',true,6],['OIRDA‚Üífront√°lis','OIRDA‚Üífrontal',false,0]]}],
    ['triphasic_deep','Triphasicus komplexek','Triphasic complexes',[
      ['Anterior‚Äìposterior k√©s√©s jellemz≈ë.','Anterior‚Äìposterior time lag.'],
      ['Metabolikus h√°tt√©r gyakori.','Often metabolic background.']
    ], {qHU:'Mi NEM igaz?', qEN:'Which is FALSE?', choices:[['Epileptiform spike‚Äìslow p√°rok','Epileptiform spike‚Äìslow pairs',true,6],['Front√°lis t√∫ls√∫ly','Frontal predominance',false,0]]}]
  ];
  const E = [
    ['burst_sup_int','Burst-supp √©rtelmez√©s','Burst-supp interpretation',[
      ['Suppressio hossza √©s ar√°nya fontos.','Suppression length and ratio matter.']
    ], {qHU:'Mi s√∫lyosabb?', qEN:'More severe?', choices:[['Hossz√∫ suppressio','Long suppression',true,8],['Magas alfa ar√°ny','High alpha ratio',false,0]]}],
    ['iic_spectrum','IIC spektrum','Ictal‚Äìinterictal continuum',[
      ['LPDs, GPDs, GPD+F mint elemek.','LPDs, GPDs, GPD+F as elements.'],
      ['Evol√∫ci√≥/klinikum d√∂nt.','Evolution/clinical context decide.']
    ], {qHU:'Mi billenti ictus fel√©?', qEN:'What favors ictus?', choices:[['Frekvencia gyorsul','Frequency accelerates',true,8],['Reakci√≥ stimulusra n≈ë','Reactivity increases',false,0]]}]
  ];
  return [...mk('beginner',B), ...mk('intermediate',I), ...mk('expert',E)];
})();
const lessonLevelSel = byId('lessonLevel'); const lessonSel = byId('lessonSel');
function buildLessonLevels(){
  const levels = [["beginner",tK('lessonsBeginner')],["intermediate",tK('lessonsIntermediate')],["expert",tK('lessonsExpert')],["all",tK('all')]];
  const prev = lessonLevelSel.value || 'beginner';
  lessonLevelSel.innerHTML=''; levels.forEach(([v,txt])=>{ const o=document.createElement('option'); o.value=v; o.textContent=txt; lessonLevelSel.appendChild(o); });
  lessonLevelSel.value = prev;
}
function refreshLessons(){
  const lvl = lessonLevelSel.value || 'beginner';
  const list = LESSONS.filter(L=> lvl==='all' || L.level===lvl);
  lessonSel.innerHTML=''; list.forEach(L=>{ const o=document.createElement('option'); o.value=L.id; o.textContent=(LANG==='HU'?L.titleHU:L.titleEN); lessonSel.appendChild(o); });
  if(lessonSel.options.length>0) lessonSel.value = lessonSel.options[0].value;
}
lessonLevelSel.onchange=()=>{ refreshLessons(); };
function renderLesson(id){
  const L = LESSONS.find(x=>x.id===id); const body=byId('lessonBody'); body.innerHTML='';
  if(!L) return;
  L.steps.forEach(step=>{ const card=document.createElement('div'); card.className='card'; card.innerHTML = (LANG==='HU'?step.htmlHU:step.htmlEN); body.appendChild(card); });
  const q=byId('lessonQuiz'); q.classList.remove('hidden');
  byId('lqQ').textContent = (LANG==='HU'?L.quiz.qHU:L.quiz.qEN);
  const choices=byId('lqChoices'); choices.innerHTML='';
  L.quiz.choices.forEach((c,i)=>{
    const id=`lq_${L.id}_${i}`;
    const wrap=document.createElement('label'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='8px';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.id=id;
    const txt=document.createElement('span'); txt.textContent=(LANG==='HU'?c.hu:c.en);
    wrap.appendChild(cb); wrap.appendChild(txt); choices.appendChild(wrap);
  });
  byId('lqSubmit').onclick=()=>{
    let gained=0, best=0;
    L.quiz.choices.forEach((c,i)=>{ best+= (c.ok?c.xp:0); const cb=choices.querySelectorAll('input')[i]; if(cb.checked && c.ok) gained+=c.xp; });
    const fb=byId('lqFb'); fb.classList.remove('hidden'); fb.classList.add('ok');
    fb.textContent = tK('gained') + gained + ' ‚Ä¢ ' + tK('bestPossible') + best;
    if(gained>0) awardXP(gained);
  };
}
byId('startLesson').onclick=()=> renderLesson(lessonSel.value);

/* ==== Drawing (safe RAF) ==== */
function fitCanvas(c){ const w=c.clientWidth*devicePixelRatio, h=c.clientHeight*devicePixelRatio; if(c.width!==w||c.height!==h){ c.width=w; c.height=h; } }
function toXY(c, i, yVal, idx, chCount, sampleRate){ const xScale = c.width / sampleRate; const chGap=(c.height-40)/chCount; const yBase=20+idx*chGap+chGap/2; const yScale=12*devicePixelRatio; return {x:i*xScale, y:yBase - yVal*yScale, yBase, chGap}; }
function drawExplore(){
  const canvas=byId('eeg'); fitCanvas(canvas);
  if(playing){ tExplore = (tExplore + 0.06*speed) % current.sampleRate; }
  const off=Math.floor(tExplore); const ctx=canvas.getContext('2d');
  ctx.fillStyle='#0b0f1a'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='#142038'; ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<canvas.height;y+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  ctx.lineWidth=2;
  current.channels.forEach((ch,idx)=>{
    const rotated = ch.data.slice(off).concat(ch.data.slice(0,off));
    ctx.strokeStyle='#dbe5ff'; ctx.beginPath();
    rotated.forEach((v,i)=>{ const p=toXY(canvas,i,v,idx,current.channels.length,current.sampleRate); if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    ctx.stroke();
    const p0=toXY(canvas,0,0,idx,current.channels.length,current.sampleRate);
    ctx.fillStyle='#93a3c8'; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.fillText(ch.name, 10*devicePixelRatio, p0.yBase - p0.chGap/2 + 14*devicePixelRatio);
    if(showAns){ ctx.strokeStyle='#ff4d4d'; ctx.lineWidth=3; ch.spikes.forEach(sx=>{ const pos=rotatedIndex(sx,off,current.sampleRate); const x=pos*(canvas.width/current.sampleRate); const y=p0.yBase - rotated[pos]*(12*devicePixelRatio); ctx.beginPath(); ctx.arc(x,y,14*devicePixelRatio,0,Math.PI*2); ctx.stroke(); }); }
  });
}
function drawIdentify(){
  const canvas=byId('eeg2'); fitCanvas(canvas); const ctx=canvas.getContext('2d');
  if(!idFreeze){ idOff=Math.floor((performance.now()*0.06*speed)%idCurrent.sampleRate); }
  const off=idOff;
  ctx.fillStyle='#0b0f1a'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='#142038'; ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<canvas.height;y+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  ctx.lineWidth=2;
  idCurrent.channels.forEach((ch,idx)=>{
    const rotated = ch.data.slice(off).concat(ch.data.slice(0,off));
    ctx.strokeStyle='#dbe5ff'; ctx.beginPath();
    rotated.forEach((v,i)=>{ const p=toXY(canvas,i,v,idx,idCurrent.channels.length,idCurrent.sampleRate); if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    ctx.stroke();
    const p0=toXY(canvas,0,0,idx,idCurrent.channels.length,idCurrent.sampleRate);
    ctx.fillStyle='#93a3c8'; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.fillText(ch.name, 10*devicePixelRatio, p0.yBase - p0.chGap/2 + 14*devicePixelRatio);
  });
}
function drawQuiz(){
  const canvas=byId('eeg3'); fitCanvas(canvas); const ctx=canvas.getContext('2d');
  if(!qFreeze){ qOff=Math.floor((performance.now()*0.06*speed)%qCurrent.sampleRate); }
  const off=qOff;
  ctx.fillStyle='#0b0f1a'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='#142038'; ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<canvas.height;y+=50*devicePixelRatio){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  ctx.lineWidth=2;
  qCurrent.channels.forEach((ch,idx)=>{
    const rotated = ch.data.slice(off).concat(ch.data.slice(0,off));
    ctx.strokeStyle='#dbe5ff'; ctx.beginPath();
    rotated.forEach((v,i)=>{ const p=toXY(canvas,i,v,idx,qCurrent.channels.length,qCurrent.sampleRate); if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    ctx.stroke();
    const p0=toXY(canvas,0,0,idx,qCurrent.channels.length,qCurrent.sampleRate);
    ctx.fillStyle='#93a3c8'; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.fillText(ch.name, 10*devicePixelRatio, p0.yBase - p0.chGap/2 + 14*devicePixelRatio);
    if(qShowAnswer){ ctx.strokeStyle='#ff4d4d'; ctx.lineWidth=3; ch.spikes.forEach(sx=>{ const pos=rotatedIndex(sx,off,qCurrent.sampleRate); const x=pos*(canvas.width/qCurrent.sampleRate); const y=p0.yBase - rotated[pos]*(12*devicePixelRatio); ctx.beginPath(); ctx.arc(x,y,14*devicePixelRatio,0,Math.PI*2); ctx.stroke(); }); }
  });
  // Jel√∂l√©sek
  ctx.strokeStyle='#60a5fa'; ctx.lineWidth=3; marks.forEach(m=>{ ctx.beginPath(); ctx.arc(m.x,m.y,18*devicePixelRatio,0,Math.PI*2); ctx.stroke(); });
  const pct=quizPct(); const hits=quizHits(off); byId('hits').textContent=String(hits); byId('pct').textContent=pct+'%'; byId('bar').style.width=pct+'%';
}

/* ==== Safe animation loop ==== */
function loop(){
  try{ drawExplore(); drawIdentify(); drawQuiz(); }
  catch(e){ const b=byId('errorBanner'); b.style.display='block'; b.textContent='Draw error: '+(e?.message||e); }
  requestAnimationFrame(loop);
}

/* ==== Events ==== */
byId('langBtn').onclick=()=>{ setLang(LANG==='HU'?'EN':'HU'); };
document.addEventListener('keydown',(e)=>{
  if(e.key===' '){
    if(mode==='explore'){ playing=!playing; byId('playBtn').textContent= playing?'‚èØÔ∏è '+tK('pause'):'‚ñ∂Ô∏è '+tK('play'); }
    if(mode==='identify'){ idFreeze=!idFreeze; }
    if(mode==='quiz'){ qFreeze=!qFreeze; }
    e.preventDefault();
  }
  if(e.key==='ArrowRight'){ speed=Math.min(5, speed+0.1); byId('speed').value=String(speed); byId('spdLbl').textContent=speed.toFixed(1)+'√ó'; }
  if(e.key==='ArrowLeft'){ speed=Math.max(0.5, speed-0.1); byId('speed').value=String(speed); byId('spdLbl').textContent=speed.toFixed(1)+'√ó'; }
});

/* ==== Init ==== */
function init(){
  refreshCaseOptions(); refreshCaseOptionsQ(); buildDifficulty(); buildLessonLevels(); refreshLessons();
  syncTexts(); setTab('explore');
  // basic self-tests (log only)
  try {
    console.assert(typeof quizTotal()==='number', 'quizTotal should return number');
    console.assert(document.getElementById('lessonSel'), 'lessonSel missing');
  } catch(e){ console.error('Self-test', e); }
  requestAnimationFrame(loop);
}
init();
</script>
</body>
</html>
